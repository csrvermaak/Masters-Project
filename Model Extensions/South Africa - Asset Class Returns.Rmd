---
title: "Replication of Faber's A Quantitative Approach to Tactical Asset Allocation - Asset Class Returns"
output: html_notebook
---

####Importing the data into R

Each asset's class price series has been saved as a CSV. The packages used for performance analysis and backtesting require the data to be xts objects which are created by the following code.
```{r, message=FALSE, warning=FALSE}
#remove past data
rm(list = ls(envir = globalenv()),envir = globalenv()) #clear Vars from global enviroment

#Load required packages
library(PerformanceAnalytics)
library(quantstrat)

#Set Symbols
symbols <- c("RiskFree","DomesticEquity","GlobalEquity","FixedIncome","Commodities","RealEstate","CPI")

#Import saved pricing data csv files as xts
getSymbols(symbols,
           src = "csv",
           dir="../Data/CSV files/SA/",
           col.names=c("Close"))
```

#### Calculating asset class returns and charting

Once the data is loaded i can create one xts object for the prices and calculate each asset class's returns. The asset class returns are then charted.
```{r}
AllAssets <- cbind.xts(Cl(RISKFREE),
                       Cl(DOMESTICEQUITY),
                       Cl(GLOBALEQUITY),
                       Cl(FIXEDINCOME),
                       Cl(COMMODITIES),
                       Cl(REALESTATE),
                       Cl(CPI))                       

#subset to required period
SubsetPeriod <- "2003-06-30::2016-12-31"

AllAssets <- AllAssets[SubsetPeriod]
colnames(AllAssets) <- symbols

#calculate returns and cum returns
AllAssets.ret <- Return.calculate(AllAssets)[-1,]
AllAssets.cumret <- 100*cumprod(1+ ROC(AllAssets, type = "discrete")[-1,])

chart.TimeSeries(AllAssets.cumret[SubsetPeriod],
 main = paste("Figure X - SA Asset Class Returns ",substr(SubsetPeriod,1,4),"-",substr(SubsetPeriod,13,16),", Log Scale",sep = ""), 
 ylab = "",
 ylog = TRUE,
 ylim = c(80,2000),
 date.format = "%Y",
 major.ticks = "years",
 legend.loc = "topleft",
 colorset = c("orangered3","olivedrab","slateblue","blue","gold2","dodgerblue2","cornflowerblue"),
 minor.ticks =FALSE)
```

####Analysing asset class returns, max drawdowns and other performance statistics

Using the package performance analytics, common performance statistics such as CAGR, volatility and sharpe ratios can be calculated.
```{r}
#subset to required dates
#SubsetPeriod <- "1972-12-31::2012-12-31"

#Create xts for Returns
Returns <- AllAssets.ret[SubsetPeriod]

#calculate statistics and store as "stats"
stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = AllAssets.ret$RiskFree),
               100*maxDrawdown(Returns,scale = 12,invert = FALSE),
               100*c(Return.annualized(Returns$CPI,scale = 12)))

#rename table rows/column names and format
colnames(stats) <- symbols
rownames(stats) <- c("Return","Volatility",paste("Sharpe (",round(stats[1,"RiskFree"],2),"%)", sep = ""),"MaxDD","Inflation CAGR")
stats <- round(stats[,-7],2)
```

Lets print the stats:
```{r, echo=FALSE}
stats

#copies stats to clipboad for pasting into word/excel
write.table(stats, "clipboard", sep="\t", col.names=NA) 
```

####Managing Risk 

Lets chart each asset with its 10 month simple moving average

```{r}
myChart_Theme <- chart_theme() #Create a chart_theme
myChart_Theme$col$line.col <- "blue"

SMAperiod <- 10

chart_Series(Cl(DOMESTICEQUITY),
  name = paste("Domestic Equity vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(GLOBALEQUITY),
  name = paste("Gloabl Equity vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(FIXEDINCOME),
  name = paste("Fixed Income vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(COMMODITIES),
  name = paste("Commodities vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(REALESTATE),
  name = paste("Real Estate vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )
```

####Calculating returns

```{r, message=FALSE, warning=FALSE}
library(dplyr)

AssetPrices <- cbind.xts(Cl(SP500),
                         Cl(EAFE),
                         Cl(US10YR),
                         Cl(GSCI),
                         Cl(NAREIT),
                         Cl(TBILLYIELDS))

AssetPrices <- AssetPrices[SubsetPeriod]

AllAssets <- cbind.xts(Cl(asset),
                       Cl(TBILLYIELDS))    

#create dataframe - tidyverse not compatible with xts?
AllAssets.df <- data.frame(date=index(AllAssets), coredata(AllAssets)) #, row.names = index(AllAssets))

#rename column for the Asset
colnames(AllAssets.df)[2] <- "Asset.Close"

#mutate new columns
AllAssets.df  <- mutate(AllAssets.df, 
  "10mSMA" = rollmean(Asset.Close,10,fill = 0,align = "right"),
  "Asset.ret" = c(0,diff(Asset.Close)/lag(Asset.Close)[-1]),
  "Rf.ret" = lag((TBILLYIELDS.Close/100)/12),
  "signal" = lag(ifelse(Asset.Close>`10mSMA`,1,0)),
  "Timing.ret" = ifelse(signal == 1,Asset.ret,Rf.ret) 
)

rownames(AllAssets.df) <- index(AllAssets)

#detach the packagae dplyr as it isn't compatible with other packages?
detach(package:dplyr)
```


AllAssets <- cbind.xts(Cl(DOMESTICEQUITY),
                       Cl(GLOBALEQUITY),
                       Cl(FIXEDINCOME),
                       Cl(COMMODITIES),
                       Cl(REALESTATE),
                       Cl(CPI))                       

#subset to required period
SubsetPeriod <- "2003-06-30::2016-12-31"

AllAssets <- AllAssets[SubsetPeriod]
colnames(AllAssets) <- symbols










#Create an xts of all assets' prices
AssetPrices <- cbind.xts(Cl(SP500),
                         Cl(EAFE),
                         Cl(US10YR),
                         Cl(GSCI),
                         Cl(NAREIT),
                         Cl(TBILLYIELDS))

AssetPrices <- AssetPrices["1972-01-31::2016-12-31"]

#Create dataframe to perform calculations (seems tidyverse not compatible with xts?)
TimingModelCalcs <- data.frame(date=index(AssetPrices), coredata(AssetPrices))
TimingModelCalcs  <- mutate(TimingModelCalcs,
  "SP500.SMA" =  rollmean(SP500.Close,10,fill = 0,align = "right"),
  "EAFE.SMA" =  rollmean(EAFE.Close,10,fill = 0,align = "right"),
  "US10YR.SMA" =  rollmean(US10YR.Close,10,fill = 0,align = "right"),
  "GSCI.SMA" =  rollmean(GSCI.Close,10,fill = 0,align = "right"),
  "NAREIT.SMA" =  rollmean(NAREIT.Close,10,fill = 0,align = "right"),
  "SP500.ret" =  c(0,diff(SP500.Close)/lag(SP500.Close)[-1]),
  "EAFE.ret" =  c(0,diff(EAFE.Close)/lag(EAFE.Close)[-1]),
  "US10YR.ret" =  c(0,diff(US10YR.Close)/lag(US10YR.Close)[-1]),
  "GSCI.ret" =  c(0,diff(GSCI.Close)/lag(GSCI.Close)[-1]),
  "NAREIT.ret" =  c(0,diff(NAREIT.Close)/lag(NAREIT.Close)[-1]),
  "RF.ret" =  lag((TBILLYIELDS.Close/100)/12),
  "SP500.signal" =  lag(ifelse(SP500.Close>=SP500.SMA,1,0)),
  "EAFE.signal" =  lag(ifelse(EAFE.Close>=EAFE.SMA,1,0)),
  "US10YR.signal" =  lag(ifelse(US10YR.Close>=US10YR.SMA,1,0)),
  "GSCI.signal" =  lag(ifelse(GSCI.Close>=GSCI.SMA,1,0)),
  "NAREIT.signal" = lag(ifelse(NAREIT.Close>=NAREIT.SMA,1,0)),
  "SP500.timingret" = ifelse(SP500.signal == 1,SP500.ret,RF.ret),
  "EAFE.timingret" = ifelse(EAFE.signal == 1,EAFE.ret,RF.ret),
  "US10YR.timingret" = ifelse(US10YR.signal == 1,US10YR.ret,RF.ret),
  "GSCI.timingret" = ifelse(GSCI.signal == 1,GSCI.ret,RF.ret),
  "NAREIT.timingret" = ifelse(NAREIT.signal == 1,NAREIT.ret,RF.ret),
  "GTAA.ret" = (SP500.timingret + EAFE.timingret + US10YR.timingret + GSCI.timingret + NAREIT.timingret)/5,
  "BUYANDHOLD.ret" = (SP500.ret + EAFE.ret + US10YR.ret + GSCI.ret + NAREIT.ret)/5
)



























####Calculating Stats

First lets create an xts of Returns
```{r}
SubsetPeriod <- "1972-12-31::2008-12-31"
AllAssets <- as.xts(AllAssets.df[,-1])
Returns <- cbind.xts(AllAssets$Asset.ret, AllAssets$Timing.ret)[SubsetPeriod]
colnames(Returns) <- c(assetname,"Timing")

#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod]

#create Cum returns for the chart
CumReturns <- 100*cumprod(1+Returns[-1,])
colnames(CumReturns) <- c(assetname,"Timing")
```

####Chart the returns

```{r}
chart.TimeSeries(CumReturns,
  main = paste(assetname," vs Timing Model ",substr(SubsetPeriod,1,4),"-",substr(SubsetPeriod,13,16),", Log Scale",sep = ""),
  date.format = "%Y",
  colorset = c(4,2),
  ylab = "",
  ylog = TRUE,
  ylim = c(50,7500),
  legend.loc = "left",
  major.ticks = "years",
  minor.ticks = FALSE)
```
