---
title: "Replication of Faber's A Quantitative Approach to Tactical Asset Allocation - South Africa"
output: html_notebook
---

####Importing the data into R

Each asset's class price series has been saved as a CSV. The packages used for performance analysis and backtesting require the data to be xts objects which are created by the following code.

```{r, message=FALSE, warning=FALSE}
#remove past data
rm(list = ls(envir = globalenv()),envir = globalenv()) #clear Vars from global enviroment

#Load required packages
library(PerformanceAnalytics)
library(quantstrat)

#Set Symbols
symbols <- c("TBILLS","JALSH","MSCIWORLD","SA10YR","GSCI","JASPY","SACPI","ALSTABL","PRUINFA")

#Import saved pricing data csv files as xts
getSymbols(symbols,
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#Define subset dates for different period
SubsetPeriod.Reporting <- "1971-12-31::2016-12-31"
SubsetPeriod.Calculations <- "1971-01-31::2016-12-31"
symbols <- c("TBILLS","JALSH","MSCIWORLD","SA10YR","GSCI","JASPY","SACPI")
```

#### Calculating asset class returns and charting

Once the data is loaded we can create one xts object for the prices and calculate each asset class's returns. The asset class returns are then charted.
```{r}
AllAssets <- cbind.xts(Cl(TBILLS),
                       Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       #Cl(JSAPY),
                       Cl(SACPI))                       

AllAssets <- AllAssets[SubsetPeriod.Reporting]
colnames(AllAssets) <- symbols[-6]

#calculate returns and cum returns
AllAssets.ret <- Return.calculate(AllAssets)[-1,]
AllAssets.cumret <- 100*cumprod(1+ ROC(AllAssets, type = "discrete")[-1,])
#how do i add a row at the top with value of 100 for each? rbind?

chart.TimeSeries(AllAssets.cumret[SubsetPeriod.Reporting],
 main = paste("SA Asset Class Returns, Log Scale",sep = ""),
 ylab = "",
 #ylog = TRUE,
 #ylim = c(100,250000),
 #date.format = "%Y",
 major.ticks = "years",
 legend.loc = "topleft",
 colorset = c("orangered3","olivedrab","slateblue","blue","gold2","dodgerblue2","cornflowerblue")
 #minor.ticks =FALSE
 )

write.table(AllAssets.cumret, "clipboard", sep="\t", col.names=NA) 

#how do i change scale format!
```

####Analysing asset class returns, max drawdowns and other performance statistics

Using the package performance analytics, common performance statistics such as CAGR, volatility and sharpe ratios can be calculated.
```{r}
#Create xts for Returns
Returns <- AllAssets.ret[SubsetPeriod.Reporting]

#calculate statistics and store as "stats"
stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS),
               100*maxDrawdown(Returns,scale = 12,invert = FALSE),
               100*c(Return.annualized(Returns$SACPI,scale = 12)))

#rename table rows/column names and format
colnames(stats) <- symbols[-6]
rownames(stats) <- c("Return",
                     "Volatility",
                     paste("Sharpe (",round(stats[1,"TBILLS"],2),"%)", sep = ""),
                     "MaxDD",
                     "Inflation CAGR")

stats <- round(stats[,-6],2) #delete inflation column - change to 7 when including property.

#print
stats

#copies stats to clipboad for pasting into word/excel
write.table(stats, "clipboard", sep="\t", col.names=NA) 
```

####Managing Risk 

Lets chart each asset with its 10 month simple moving average

```{r}
myChart_Theme <- chart_theme() #Create a chart_theme
myChart_Theme$col$line.col <- "blue"

SMAperiod <- 10

chart_Series(Cl(JALSH),
  name = paste("JALSH vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(MSCIWORLD),
  name = paste("MSCI World vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(SA10YR),
  name = paste("SA10YR vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(GSCI),
  name = paste("GSCI vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

#change to other chart so can make it log?
```

####Calculating returns

```{r, message=FALSE, warning=FALSE}
#Import saved pricing data csv files as xts
getSymbols("TBILLYIELDS",
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#load an additional library
library(dplyr)

#Create new all assets
AllAssets <- cbind.xts(Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       Cl(TBILLYIELDS))   

AllAssets <- AllAssets[SubsetPeriod.Calculations]

#create dataframe - tidyverse not compatible with xts?
AllAssets.df <- data.frame(date=index(AllAssets), coredata(AllAssets)) #, row.names = index(AllAssets))

BuyBand <- 1.025
SellBand <- 1.00
#mutate new columns
AllAssets.df  <- mutate(AllAssets.df,
  "RF.ret" =  c(0,lag((TBILLYIELDS.Close/100)/12)[-1]), 
  #is this right?

  "JALSH.ret" =  c(0,diff(JALSH.Close)/lag(JALSH.Close)[-1]),
  
  "JALSH.2m.SMA" =  rollmean(JALSH.Close,2,fill = 0,align = "right"),
  "JALSH.5m.SMA" =  rollmean(JALSH.Close,5,fill = 0,align = "right"),
  "JALSH.10m.SMA" =  rollmean(JALSH.Close,10,fill = 0,align = "right"),
  
  "JALSH.2m.signal" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,1,0)),
  "JALSH.5m.signal" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,1,0)),
  "JALSH.10m.signal" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,1,0)),
  "JALSH.2m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,ifelse(JALSH.2m.signal==1,1,0),0)),
  "JALSH.5m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,ifelse(JALSH.5m.signal==1,1,0),0)),  
  "JALSH.10m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,ifelse(JALSH.10m.signal==1,1,0),0)),

  "JALSH.2m.timingret" = ifelse(JALSH.2m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret" = ifelse(JALSH.5m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret" = ifelse(JALSH.10m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.2m.timingret.delayed" = ifelse(JALSH.2m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret.delayed" = ifelse(JALSH.5m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret.delayed" = ifelse(JALSH.10m.signal.delayed == 1,JALSH.ret,RF.ret),

  "JALSH.avg.timingret" = (JALSH.2m.timingret + JALSH.5m.timingret + JALSH.10m.timingret)/3,
  "JALSH.avg.signal" = (JALSH.2m.signal + JALSH.5m.signal + JALSH.10m.signal)/3,
  "JALSH.avg.timingret.delayed" = (JALSH.2m.timingret.delayed + JALSH.5m.timingret.delayed + JALSH.10m.timingret.delayed)/3,  
  "JALSH.avg.signal.delayed" = (JALSH.2m.signal.delayed + JALSH.5m.signal.delayed + JALSH.10m.signal.delayed)/3, 
  "JALSH.avg.combo" = (JALSH.avg.timingret + JALSH.avg.timingret.delayed)/2,
  "JALSH.avg.combo.signal" = (JALSH.avg.signal + JALSH.avg.signal.delayed)/2,

  "MSCIWORLD.ret" =  c(0,diff(MSCIWORLD.Close)/lag(MSCIWORLD.Close)[-1]),
  
  "MSCIWORLD.2m.SMA" =  rollmean(MSCIWORLD.Close,2,fill = 0,align = "right"),
  "MSCIWORLD.5m.SMA" =  rollmean(MSCIWORLD.Close,5,fill = 0,align = "right"),
  "MSCIWORLD.10m.SMA" =  rollmean(MSCIWORLD.Close,10,fill = 0,align = "right"),
  
  "MSCIWORLD.2m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,1,0)),
  "MSCIWORLD.5m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,1,0)),
  "MSCIWORLD.10m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,1,0)),
  "MSCIWORLD.2m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,ifelse(MSCIWORLD.2m.signal==1,1,0),0)),
  "MSCIWORLD.5m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,ifelse(MSCIWORLD.5m.signal==1,1,0),0)),  
  "MSCIWORLD.10m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,ifelse(MSCIWORLD.10m.signal==1,1,0),0)),

  "MSCIWORLD.2m.timingret" = ifelse(MSCIWORLD.2m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret" = ifelse(MSCIWORLD.5m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret" = ifelse(MSCIWORLD.10m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.2m.timingret.delayed" = ifelse(MSCIWORLD.2m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret.delayed" = ifelse(MSCIWORLD.5m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret.delayed" = ifelse(MSCIWORLD.10m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  
  "MSCIWORLD.avg.timingret" = (MSCIWORLD.2m.timingret + MSCIWORLD.5m.timingret + MSCIWORLD.10m.timingret)/3,
  "MSCIWORLD.avg.signal" = (MSCIWORLD.2m.signal + MSCIWORLD.5m.signal + MSCIWORLD.10m.signal)/3,
  "MSCIWORLD.avg.timingret.delayed" = (MSCIWORLD.2m.timingret.delayed + MSCIWORLD.5m.timingret.delayed + MSCIWORLD.10m.timingret.delayed)/3,  
  "MSCIWORLD.avg.signal.delayed" = (MSCIWORLD.2m.signal.delayed + MSCIWORLD.5m.signal.delayed + MSCIWORLD.10m.signal.delayed)/3,  
  "MSCIWORLD.avg.combo" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed)/2,
  "MSCIWORLD.avg.combo.signal" = (MSCIWORLD.avg.signal + MSCIWORLD.avg.signal.delayed)/2,
  
  "MSCIWORLD.avg.combo" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed)/2,
  "MSCIWORLD.avg.combo.signal" = (MSCIWORLD.avg.signal + MSCIWORLD.avg.signal.delayed)/2,
  
  "SA10YR.ret" =  c(0,diff(SA10YR.Close)/lag(SA10YR.Close)[-1]),
  
  "SA10YR.2m.SMA" =  rollmean(SA10YR.Close,2,fill = 0,align = "right"),
  "SA10YR.5m.SMA" =  rollmean(SA10YR.Close,5,fill = 0,align = "right"),
  "SA10YR.10m.SMA" =  rollmean(SA10YR.Close,10,fill = 0,align = "right"),
  
  "SA10YR.2m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,1,0)),
  "SA10YR.5m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,1,0)),
  "SA10YR.10m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,1,0)),
  "SA10YR.2m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,ifelse(SA10YR.2m.signal==1,1,0),0)),
  "SA10YR.5m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,ifelse(SA10YR.5m.signal==1,1,0),0)),  
  "SA10YR.10m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,ifelse(SA10YR.10m.signal==1,1,0),0)),
  
  "SA10YR.2m.timingret" = ifelse(SA10YR.2m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret" = ifelse(SA10YR.5m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret" = ifelse(SA10YR.10m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.2m.timingret.delayed" = ifelse(SA10YR.2m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret.delayed" = ifelse(SA10YR.5m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret.delayed" = ifelse(SA10YR.10m.signal.delayed == 1,SA10YR.ret,RF.ret),
  
  "SA10YR.avg.timingret" = (SA10YR.2m.timingret + SA10YR.5m.timingret + SA10YR.10m.timingret)/3,
  "SA10YR.avg.signal" = (SA10YR.2m.signal + SA10YR.5m.signal + SA10YR.10m.signal)/3,
  "SA10YR.avg.timingret.delayed" = (SA10YR.2m.timingret.delayed + SA10YR.5m.timingret.delayed + SA10YR.10m.timingret.delayed)/3,  
  "SA10YR.avg.signal.delayed" = (SA10YR.2m.signal.delayed + SA10YR.5m.signal.delayed + SA10YR.10m.signal.delayed)/3,  
  "SA10YR.avg.combo" = (SA10YR.avg.timingret + SA10YR.avg.timingret.delayed)/2,
  "SA10YR.avg.combo.signal" = (SA10YR.avg.signal + SA10YR.avg.signal.delayed)/2,

  "GSCI.ret" =  c(0,diff(GSCI.Close)/lag(GSCI.Close)[-1]),
  
  "GSCI.2m.SMA" =  rollmean(GSCI.Close,2,fill = 0,align = "right"),
  "GSCI.5m.SMA" =  rollmean(GSCI.Close,5,fill = 0,align = "right"),
  "GSCI.10m.SMA" =  rollmean(GSCI.Close,10,fill = 0,align = "right"),
  
  "GSCI.2m.signal" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,1,0)),
  "GSCI.5m.signal" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,1,0)),
  "GSCI.10m.signal" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,1,0)),
  "GSCI.2m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,ifelse(GSCI.2m.signal==1,1,0),0)),
  "GSCI.5m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,ifelse(GSCI.5m.signal==1,1,0),0)),  
  "GSCI.10m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,ifelse(GSCI.10m.signal==1,1,0),0)),
   
  "GSCI.2m.timingret" = ifelse(GSCI.2m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret" = ifelse(GSCI.5m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret" = ifelse(GSCI.10m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.2m.timingret.delayed" = ifelse(GSCI.2m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret.delayed" = ifelse(GSCI.5m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret.delayed" = ifelse(GSCI.10m.signal.delayed == 1,GSCI.ret,RF.ret),

  "GSCI.avg.timingret" = (GSCI.2m.timingret + GSCI.5m.timingret + GSCI.10m.timingret)/3,
  "GSCI.avg.signal" = (GSCI.2m.signal + GSCI.5m.signal + GSCI.10m.signal)/3,
  "GSCI.avg.timingret.delayed" = (GSCI.2m.timingret.delayed + GSCI.5m.timingret.delayed + GSCI.10m.timingret.delayed)/3,  
  "GSCI.avg.signal.delayed" = (GSCI.2m.signal.delayed + GSCI.5m.signal.delayed + GSCI.10m.signal.delayed)/3,  
  "GSCI.avg.combo" = (GSCI.avg.timingret + GSCI.avg.timingret.delayed)/2,
  "GSCI.avg.combo.signal" = (GSCI.avg.signal + GSCI.avg.signal.delayed)/2,


  "JALSH.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(JALSH.Close>=(BuyBand*JALSH.2m.SMA),1,
                                        ifelse(JALSH.Close<(SellBand*JALSH.2m.SMA),0,2)))),  
  "JALSH.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(JALSH.Close>=(BuyBand*JALSH.5m.SMA),1,
                                        ifelse(JALSH.Close<(SellBand*JALSH.5m.SMA),0,2)))),  
  "JALSH.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(JALSH.Close>=(BuyBand*JALSH.10m.SMA),1,
                                        ifelse(JALSH.Close<(SellBand*JALSH.10m.SMA),0,2)))),
  
  "MSCIWORLD.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(MSCIWORLD.Close>=(BuyBand*MSCIWORLD.2m.SMA),1,
                                        ifelse(MSCIWORLD.Close<(SellBand*MSCIWORLD.2m.SMA),0,2)))),  
  "MSCIWORLD.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(MSCIWORLD.Close>=(BuyBand*MSCIWORLD.5m.SMA),1,
                                        ifelse(MSCIWORLD.Close<(SellBand*MSCIWORLD.5m.SMA),0,2)))),  
  "MSCIWORLD.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(MSCIWORLD.Close>=(BuyBand*MSCIWORLD.10m.SMA),1,
                                        ifelse(MSCIWORLD.Close<(SellBand*MSCIWORLD.10m.SMA),0,2)))),      
  
  "SA10YR.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(SA10YR.Close>=(BuyBand*SA10YR.2m.SMA),1,
                                        ifelse(SA10YR.Close<(SellBand*SA10YR.2m.SMA),0,2)))),  
  "SA10YR.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(SA10YR.Close>=(BuyBand*SA10YR.5m.SMA),1,
                                        ifelse(SA10YR.Close<(SellBand*SA10YR.5m.SMA),0,2)))),  
  "SA10YR.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(SA10YR.Close>=(BuyBand*SA10YR.10m.SMA),1,
                                        ifelse(SA10YR.Close<(SellBand*SA10YR.10m.SMA),0,2)))),

  "GSCI.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(GSCI.Close>=(BuyBand*GSCI.2m.SMA),1,
                                        ifelse(GSCI.Close<(SellBand*GSCI.2m.SMA),0,2)))),  
  "GSCI.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(GSCI.Close>=(BuyBand*GSCI.5m.SMA),1,
                                        ifelse(GSCI.Close<(SellBand*GSCI.5m.SMA),0,2)))),  
  "GSCI.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(GSCI.Close>=(BuyBand*GSCI.10m.SMA),1,
                                        ifelse(GSCI.Close<(SellBand*GSCI.10m.SMA),0,2)))),  

  "BuyandHold.ret" = (JALSH.ret + MSCIWORLD.ret + SA10YR.ret + GSCI.ret)/4,
  
  "Timing.ret" = (JALSH.10m.timingret + MSCIWORLD.10m.timingret + SA10YR.10m.timingret + GSCI.10m.timingret)/4,
  "Timing.signal" = (JALSH.10m.signal + MSCIWORLD.10m.signal + SA10YR.10m.signal + GSCI.10m.signal)/4,
  
  "DelayedTiming.ret" = (JALSH.10m.timingret.delayed + MSCIWORLD.10m.timingret.delayed + SA10YR.10m.timingret.delayed + GSCI.10m.timingret.delayed)/4,
  "DelayedTiming.signal" = (JALSH.10m.signal.delayed + MSCIWORLD.10m.signal.delayed + SA10YR.10m.signal.delayed + GSCI.10m.signal.delayed)/4,
  
  "Avg.Timing.ret" = (JALSH.avg.timingret + MSCIWORLD.avg.timingret + SA10YR.avg.timingret + GSCI.avg.timingret)/4,
  "Avg.Timing.signal" = (JALSH.avg.signal + MSCIWORLD.avg.signal + SA10YR.avg.signal + GSCI.avg.signal)/4,
  
  "Avg.DelayedTiming.ret" = (JALSH.avg.timingret.delayed + MSCIWORLD.avg.timingret.delayed + 
                            SA10YR.avg.timingret.delayed + GSCI.avg.timingret.delayed)/4,
  "Avg.DelayedTiming.signal" = (JALSH.avg.signal.delayed + MSCIWORLD.avg.signal.delayed + 
                            SA10YR.avg.signal.delayed + GSCI.avg.signal.delayed)/4,
  
  "Avg.Combo.ret" = (JALSH.avg.combo + MSCIWORLD.avg.combo + 
                            SA10YR.avg.combo + GSCI.avg.combo)/4,
  "Avg.Combo.signal" = (JALSH.avg.combo.signal + MSCIWORLD.avg.combo.signal + 
                            SA10YR.avg.combo.signal + GSCI.avg.combo.signal)/4
  
  )

# update signal for band strategy
for(i in 1:length(AllAssets.df$JALSH.10m.signal.band)){
  if(AllAssets.df$JALSH.2m.signal.band[i] == 2){AllAssets.df$JALSH.2m.signal.band[i] = AllAssets.df$JALSH.2m.signal.band[i-1]}
  if(AllAssets.df$JALSH.5m.signal.band[i] == 2){AllAssets.df$JALSH.5m.signal.band[i] = AllAssets.df$JALSH.5m.signal.band[i-1]}
  if(AllAssets.df$JALSH.10m.signal.band[i] == 2){AllAssets.df$JALSH.10m.signal.band[i] = AllAssets.df$JALSH.10m.signal.band[i-1]}
  
  if(AllAssets.df$MSCIWORLD.2m.signal.band[i] == 2){AllAssets.df$MSCIWORLD.2m.signal.band[i] = AllAssets.df$MSCIWORLD.2m.signal.band[i-1]}
  if(AllAssets.df$MSCIWORLD.5m.signal.band[i] == 2){AllAssets.df$MSCIWORLD.5m.signal.band[i] = AllAssets.df$MSCIWORLD.5m.signal.band[i-1]}
  if(AllAssets.df$MSCIWORLD.10m.signal.band[i] == 2){AllAssets.df$MSCIWORLD.10m.signal.band[i] = AllAssets.df$MSCIWORLD.10m.signal.band[i-1]}
  
  if(AllAssets.df$SA10YR.2m.signal.band[i] == 2){AllAssets.df$SA10YR.2m.signal.band[i] = AllAssets.df$SA10YR.2m.signal.band[i-1]}
  if(AllAssets.df$SA10YR.5m.signal.band[i] == 2){AllAssets.df$SA10YR.5m.signal.band[i] = AllAssets.df$SA10YR.5m.signal.band[i-1]}
  if(AllAssets.df$SA10YR.10m.signal.band[i] == 2){AllAssets.df$SA10YR.10m.signal.band[i] = AllAssets.df$SA10YR.10m.signal.band[i-1]}  
  
  if(AllAssets.df$GSCI.2m.signal.band[i] == 2){AllAssets.df$GSCI.2m.signal.band[i] = AllAssets.df$GSCI.2m.signal.band[i-1]}
  if(AllAssets.df$GSCI.5m.signal.band[i] == 2){AllAssets.df$GSCI.5m.signal.band[i] = AllAssets.df$GSCI.5m.signal.band[i-1]}
  if(AllAssets.df$GSCI.10m.signal.band[i] == 2){AllAssets.df$GSCI.10m.signal.band[i] = AllAssets.df$GSCI.10m.signal.band[i-1]}

}

#calculat returns for band strategy

AllAssets.df  <- mutate(AllAssets.df,

  "JALSH.2m.timingret.band" = ifelse(JALSH.2m.signal.band == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret.band" = ifelse(JALSH.5m.signal.band == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret.band" = ifelse(JALSH.10m.signal.band == 1,JALSH.ret,RF.ret),
  
  "JALSH.avg.timingret.band" = (JALSH.2m.timingret.band + JALSH.5m.timingret.band + JALSH.10m.timingret.band)/3,  
  "JALSH.avg.signal.band" = (JALSH.2m.signal.band + JALSH.5m.signal.band + JALSH.10m.signal.band)/3, 

  "JALSH.avg.combo.band" = (JALSH.avg.timingret + JALSH.avg.timingret.delayed  + JALSH.avg.timingret.band)/3,
  "JALSH.avg.combo.band.signal" = (JALSH.avg.signal + JALSH.avg.signal.delayed + JALSH.avg.signal.band)/3,

  "MSCIWORLD.2m.timingret.band" = ifelse(MSCIWORLD.2m.signal.band == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret.band" = ifelse(MSCIWORLD.5m.signal.band == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret.band" = ifelse(MSCIWORLD.10m.signal.band == 1,MSCIWORLD.ret,RF.ret),
  
  "MSCIWORLD.avg.timingret.band" = (MSCIWORLD.2m.timingret.band + MSCIWORLD.5m.timingret.band + MSCIWORLD.10m.timingret.band)/3,  
  "MSCIWORLD.avg.signal.band" = (MSCIWORLD.2m.signal.band + MSCIWORLD.5m.signal.band + MSCIWORLD.10m.signal.band)/3, 

  "MSCIWORLD.avg.combo.band" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed  + MSCIWORLD.avg.timingret.band)/3,
  "MSCIWORLD.avg.combo.band.signal" = (MSCIWORLD.avg.signal + MSCIWORLD.avg.signal.delayed + MSCIWORLD.avg.signal.band)/3,
  
  "SA10YR.2m.timingret.band" = ifelse(SA10YR.2m.signal.band == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret.band" = ifelse(SA10YR.5m.signal.band == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret.band" = ifelse(SA10YR.10m.signal.band == 1,SA10YR.ret,RF.ret),
  
  "SA10YR.avg.timingret.band" = (SA10YR.2m.timingret.band + SA10YR.5m.timingret.band + SA10YR.10m.timingret.band)/3,  
  "SA10YR.avg.signal.band" = (SA10YR.2m.signal.band + SA10YR.5m.signal.band + SA10YR.10m.signal.band)/3, 

  "SA10YR.avg.combo.band" = (SA10YR.avg.timingret + SA10YR.avg.timingret.delayed  + SA10YR.avg.timingret.band)/3,
  "SA10YR.avg.combo.band.signal" = (SA10YR.avg.signal + SA10YR.avg.signal.delayed + SA10YR.avg.signal.band)/3,
  
  "GSCI.2m.timingret.band" = ifelse(GSCI.2m.signal.band == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret.band" = ifelse(GSCI.5m.signal.band == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret.band" = ifelse(GSCI.10m.signal.band == 1,GSCI.ret,RF.ret),
  
  "GSCI.avg.timingret.band" = (GSCI.2m.timingret.band + GSCI.5m.timingret.band + GSCI.10m.timingret.band)/3,  
  "GSCI.avg.signal.band" = (GSCI.2m.signal.band + GSCI.5m.signal.band + GSCI.10m.signal.band)/3, 

  "GSCI.avg.combo.band" = (GSCI.avg.timingret + GSCI.avg.timingret.delayed  + GSCI.avg.timingret.band)/3,
  "GSCI.avg.combo.band.signal" = (GSCI.avg.signal + GSCI.avg.signal.delayed + GSCI.avg.signal.band)/3,

  "BandTiming.ret" = (JALSH.10m.timingret.band + MSCIWORLD.10m.timingret.band
                         + SA10YR.10m.timingret.band + GSCI.10m.timingret.band)/4,
  "BandTiming.signal" = (JALSH.10m.signal.band + MSCIWORLD.10m.signal.band
                            + SA10YR.10m.signal.band + GSCI.10m.signal.band)/4,

  "Avg.BandTiming.ret" = (JALSH.avg.timingret.band + MSCIWORLD.avg.timingret.band +
                            SA10YR.avg.timingret.band + GSCI.avg.timingret.band)/4,
  "Avg.BandTiming.signal" = (JALSH.avg.signal.band + MSCIWORLD.avg.signal.band +
                            SA10YR.avg.signal.band + GSCI.avg.signal.band)/4,

  "Avg.Combo.Band.ret" = (JALSH.avg.combo.band + MSCIWORLD.avg.combo.band +
                            SA10YR.avg.combo.band + GSCI.avg.combo.band)/4,
  "Avg.Combo.Band.signal" = (JALSH.avg.combo.band.signal + MSCIWORLD.avg.combo.band.signal +
                            SA10YR.avg.combo.band.signal + GSCI.avg.combo.band.signal)/4

  )

rownames(AllAssets.df) <- index(AllAssets)

#Create xts of calculations to analyse performance
AllAssets.xts <- xts(AllAssets.df[,-1], order.by = AllAssets.df$date)

#detach the packagae dplyr as it isn't compatible with other packages?
detach(package:dplyr)
```

#### Individual Asset Class Strategy Comparisons and Stats

```{r}
#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLYIELDS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

FormatMultiplier <- 100

Strategies <- c("B&H","Timing","Timing Delayed","Timing Band","Multi Timing","Multi Strat")

PerformanceMeasures <- c("CAGR","Volatility","Skew","Kurtosis","Inflation CAGR","% in the Market","% positive Months","Best Month","Worst Month","Max Drawdown","Max Drawdown / CAGR",paste("Sharpe Ratio (",round(100*Return.annualized(Return.calculate(TBILLS)[SubsetPeriod.Reporting]),2),"%)", sep = ""),"Sortino Ratio","MAR Ratio","Ulcer Index")

```

#### JALSH

```{r}
Returns <- cbind.xts(AllAssets.xts$JALSH.ret, 
                     AllAssets.xts$JALSH.10m.timingret, 
                     AllAssets.xts$JALSH.10m.timingret.delayed,
                     AllAssets.xts$JALSH.10m.timingret.band,
                     AllAssets.xts$JALSH.avg.timingret,
                     AllAssets.xts$JALSH.avg.combo.band)[SubsetPeriod.Reporting]

colnames(Returns) <- Strategies

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Strategy Returns, 1972-2016, Log Scale",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Strategy Drawdowns, 1972-2016, Log Scale",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JALSH.10m.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JALSH.10m.signal.delayed[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JALSH.10m.signal.band[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JALSH.avg.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JALSH.avg.combo.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- Strategies

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)


```


#### MSCIWORLD
```{r}
Returns <- cbind.xts(AllAssets.xts$MSCIWORLD.ret, 
                     AllAssets.xts$MSCIWORLD.10m.timingret, 
                     AllAssets.xts$MSCIWORLD.10m.timingret.delayed,
                     AllAssets.xts$MSCIWORLD.10m.timingret.band,
                     AllAssets.xts$MSCIWORLD.avg.timingret,
                     AllAssets.xts$MSCIWORLD.avg.combo.band)[SubsetPeriod.Reporting]

colnames(Returns) <- Strategies

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Strategy Returns, 1972-2016, Log Scale",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Strategy Drawdowns, 1972-2016, Log Scale",
  date.format = "%Y",
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$MSCIWORLD.10m.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$MSCIWORLD.10m.signal.delayed[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$MSCIWORLD.10m.signal.band[SubsetPeriod.Reporting]),                  
                  sum(AllAssets.xts$MSCIWORLD.avg.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$MSCIWORLD.avg.combo.band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- Strategies

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)

```


#### SA10YR
```{r}
Returns <- cbind.xts(AllAssets.xts$SA10YR.ret, 
                     AllAssets.xts$SA10YR.10m.timingret, 
                     AllAssets.xts$SA10YR.10m.timingret.delayed,
                     AllAssets.xts$SA10YR.10m.timingret.band,
                     AllAssets.xts$SA10YR.avg.timingret,
                     AllAssets.xts$SA10YR.avg.combo.band)[SubsetPeriod.Reporting]

colnames(Returns) <- Strategies

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Strategy Returns, 1972-2016, Log Scale",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Strategy Drawdowns, 1972-2016, Log Scale",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SA10YR.10m.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SA10YR.10m.signal.delayed[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SA10YR.10m.signal.bandd[SubsetPeriod.Reporting]),                  
                  sum(AllAssets.xts$SA10YR.avg.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SA10YR.avg.combo.band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- Strategies

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
write.table(round(Returns,4), "clipboard", sep="\t", col.names=NA)
```


#### GSCI
```{r}
Returns <- cbind.xts(AllAssets.xts$GSCI.ret, 
                     AllAssets.xts$GSCI.10m.timingret, 
                     AllAssets.xts$GSCI.10m.timingret.delayed,
                     AllAssets.xts$GSCI.10m.timingret.band,
                     AllAssets.xts$GSCI.avg.timingret,
                     AllAssets.xts$GSCI.avg.combo.band)[SubsetPeriod.Reporting]

colnames(Returns) <- Strategies

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Strategy Returns, 1972-2016, Log Scale",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Strategy Drawdowns, 1972-2016, Log Scale",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$GSCI.10m.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$GSCI.10m.signal.delayed[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$GSCI.10m.signal.band[SubsetPeriod.Reporting]),                  
                  sum(AllAssets.xts$GSCI.avg.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$GSCI.avg.combo.band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- Strategies

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
write.table(round(Returns,4), "clipboard", sep="\t", col.names=NA)
```

#### GTAA
```{r}
Returns <- cbind.xts(AllAssets.xts$BuyandHold.ret,
                     AllAssets.xts$Timing.ret,
                     AllAssets.xts$DelayedTiming.ret,
                     AllAssets.xts$BandTiming.ret,
                     AllAssets.xts$Avg.Timing.ret,
                     AllAssets.xts$Avg.Combo.Band.ret)[SubsetPeriod.Reporting]

colnames(Returns) <- Strategies

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Strategy Returns, 1972-2016, Log Scale",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Strategy Drawdowns, 1972-2016, Log Scale",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$DelayedTiming.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$BandTiming.signal[SubsetPeriod.Reporting]),                  
                  sum(AllAssets.xts$Avg.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$Avg.Combo.Band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- Strategies

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
write.table(round(Returns,4), "clipboard", sep="\t", col.names=NA)
```

Stats Including Property

```{r, message=FALSE, warning=FALSE}
#remove past data
rm(list = ls(envir = globalenv()),envir = globalenv()) #clear Vars from global enviroment

#Load required packages
library(PerformanceAnalytics)
library(quantstrat)

#Set Symbols
symbols <- c("TBILLS","JALSH","MSCIWORLD","SA10YR","GSCI","JASPY","SACPI")

#Import saved pricing data csv files as xts
getSymbols(symbols,
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#Define subset dates for different period
SubsetPeriod.Reporting <- "1993-12-31::2016-12-31"
SubsetPeriod.Calculations <- "1992-12-31::2016-12-31"
```

#### Calculating asset class returns and charting

Once the data is loaded we can create one xts object for the prices and calculate each asset class's returns. The asset class returns are then charted.
```{r}
AllAssets <- cbind.xts(Cl(TBILLS),
                       Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       Cl(JASPY),
                       Cl(SACPI))                       

AllAssets <- AllAssets[SubsetPeriod.Calculations]
colnames(AllAssets) <- symbols

#calculate returns and cum returns
AllAssets.ret <- Return.calculate(AllAssets)[-1,]
AllAssets.cumret <- 100*cumprod(1+ ROC(AllAssets, type = "discrete")[-1,])
#how do i add a row at the top with value of 100 for each? rbind?

chart.TimeSeries(AllAssets.cumret[SubsetPeriod.Reporting],
 main = "SA Asset Class Returns, 1994-2016, Log Scale",
 ylab = "",
 #ylog = TRUE,
 #ylim = c(100,250000),
 #date.format = "%Y",
 major.ticks = "years",
 legend.loc = "topleft",
 colorset = c("orangered3","olivedrab","slateblue","blue","gold2","dodgerblue2","cornflowerblue")
 #minor.ticks =FALSE
 )

write.table(round(AllAssets.cumret,4), "clipboard", sep="\t", col.names=NA)
```

####Analysing asset class returns, max drawdowns and other performance statistics

```{r}
#Create xts for Returns
Returns <- AllAssets.ret[SubsetPeriod.Reporting]

#calculate statistics and store as "stats"
stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS),
               100*maxDrawdown(Returns,scale = 12,invert = FALSE),
               100*c(Return.annualized(Returns$SACPI,scale = 12)))

#rename table rows/column names and format
colnames(stats) <- symbols
rownames(stats) <- c("Return","Volatility",
                     paste("Sharpe (",round(stats[1,"TBILLS"],2),"%)", sep = ""),
                     "MaxDD","Inflation CAGR")

stats <- round(stats[,-7],2)

#print
stats

#copies stats to clipboad for pasting into word/excel
write.table(stats, "clipboard", sep="\t", col.names=NA) 
```

####Managing Risk 

Lets chart each asset with its 10 month simple moving average

```{r}
myChart_Theme <- chart_theme() #Create a chart_theme
myChart_Theme$col$line.col <- "blue"

SMAperiod <- 10

chart_Series(Cl(JASPY),
  name = paste("JASPY vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

#change to other chart so can make it log?
```

####Calculating returns

```{r, message=FALSE, warning=FALSE}
#Import saved pricing data csv files as xts
getSymbols("TBILLYIELDS",
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#load an additional library
library(dplyr)

#Create new all assets
AllAssets <- cbind.xts(Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       Cl(JASPY),
                       Cl(TBILLYIELDS))   

AllAssets <- AllAssets[SubsetPeriod.Calculations]

#create dataframe - tidyverse not compatible with xts?
AllAssets.df <- data.frame(date=index(AllAssets), coredata(AllAssets)) #, row.names = index(AllAssets))

BuyBand <- 1.025
SellBand <- 1.00

#mutate new columns
AllAssets.df  <- mutate(AllAssets.df,
  "RF.ret" =  c(0,lag((TBILLYIELDS.Close/100)/12)[-1]), 
  #is this right?

  "JALSH.ret" =  c(0,diff(JALSH.Close)/lag(JALSH.Close)[-1]),
  
  "JALSH.2m.SMA" =  rollmean(JALSH.Close,2,fill = 0,align = "right"),
  "JALSH.5m.SMA" =  rollmean(JALSH.Close,5,fill = 0,align = "right"),
  "JALSH.10m.SMA" =  rollmean(JALSH.Close,10,fill = 0,align = "right"),
  
  "JALSH.2m.signal" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,1,0)),
  "JALSH.5m.signal" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,1,0)),
  "JALSH.10m.signal" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,1,0)),
  "JALSH.2m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,ifelse(JALSH.2m.signal==1,1,0),0)),
  "JALSH.5m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,ifelse(JALSH.5m.signal==1,1,0),0)),  
  "JALSH.10m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,ifelse(JALSH.10m.signal==1,1,0),0)),

  "JALSH.2m.timingret" = ifelse(JALSH.2m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret" = ifelse(JALSH.5m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret" = ifelse(JALSH.10m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.2m.timingret.delayed" = ifelse(JALSH.2m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret.delayed" = ifelse(JALSH.5m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret.delayed" = ifelse(JALSH.10m.signal.delayed == 1,JALSH.ret,RF.ret),
  
  "JALSH.avg.timingret" = (JALSH.2m.timingret + JALSH.5m.timingret + JALSH.10m.timingret)/3,
  "JALSH.avg.signal" = (JALSH.2m.signal + JALSH.5m.signal + JALSH.10m.signal)/3,
  "JALSH.avg.timingret.delayed" = (JALSH.2m.timingret.delayed + JALSH.5m.timingret.delayed + JALSH.10m.timingret.delayed)/3,  
  "JALSH.avg.signal.delayed" = (JALSH.2m.signal.delayed + JALSH.5m.signal.delayed + JALSH.10m.signal.delayed)/3, 
  "JALSH.avg.combo" = (JALSH.avg.timingret + JALSH.avg.timingret.delayed)/2,
  "JALSH.avg.combo.signal" = (JALSH.avg.signal + JALSH.avg.signal.delayed)/2,

  "MSCIWORLD.ret" =  c(0,diff(MSCIWORLD.Close)/lag(MSCIWORLD.Close)[-1]),
  
  "MSCIWORLD.2m.SMA" =  rollmean(MSCIWORLD.Close,2,fill = 0,align = "right"),
  "MSCIWORLD.5m.SMA" =  rollmean(MSCIWORLD.Close,5,fill = 0,align = "right"),
  "MSCIWORLD.10m.SMA" =  rollmean(MSCIWORLD.Close,10,fill = 0,align = "right"),
  
  "MSCIWORLD.2m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,1,0)),
  "MSCIWORLD.5m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,1,0)),
  "MSCIWORLD.10m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,1,0)),
  "MSCIWORLD.2m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,ifelse(MSCIWORLD.2m.signal==1,1,0),0)),
  "MSCIWORLD.5m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,ifelse(MSCIWORLD.5m.signal==1,1,0),0)),  
  "MSCIWORLD.10m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,ifelse(MSCIWORLD.10m.signal==1,1,0),0)),
  
  "MSCIWORLD.2m.timingret" = ifelse(MSCIWORLD.2m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret" = ifelse(MSCIWORLD.5m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret" = ifelse(MSCIWORLD.10m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.2m.timingret.delayed" = ifelse(MSCIWORLD.2m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret.delayed" = ifelse(MSCIWORLD.5m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret.delayed" = ifelse(MSCIWORLD.10m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  
  "MSCIWORLD.avg.timingret" = (MSCIWORLD.2m.timingret + MSCIWORLD.5m.timingret + MSCIWORLD.10m.timingret)/3,
  "MSCIWORLD.avg.signal" = (MSCIWORLD.2m.signal + MSCIWORLD.5m.signal + MSCIWORLD.10m.signal)/3,
  "MSCIWORLD.avg.timingret.delayed" = (MSCIWORLD.2m.timingret.delayed + MSCIWORLD.5m.timingret.delayed + MSCIWORLD.10m.timingret.delayed)/3,  
  "MSCIWORLD.avg.signal.delayed" = (MSCIWORLD.2m.signal.delayed + MSCIWORLD.5m.signal.delayed + MSCIWORLD.10m.signal.delayed)/3,  
  "MSCIWORLD.avg.combo" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed)/2,
  "MSCIWORLD.avg.combo.signal" = (MSCIWORLD.avg.signal + MSCIWORLD.avg.signal.delayed)/2,
  
  "MSCIWORLD.avg.combo" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed)/2,
  "MSCIWORLD.avg.combo.signal" = (MSCIWORLD.avg.signal + MSCIWORLD.avg.signal.delayed)/2,
  
  "SA10YR.ret" =  c(0,diff(SA10YR.Close)/lag(SA10YR.Close)[-1]),
  
  "SA10YR.2m.SMA" =  rollmean(SA10YR.Close,2,fill = 0,align = "right"),
  "SA10YR.5m.SMA" =  rollmean(SA10YR.Close,5,fill = 0,align = "right"),
  "SA10YR.10m.SMA" =  rollmean(SA10YR.Close,10,fill = 0,align = "right"),
  
  "SA10YR.2m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,1,0)),
  "SA10YR.5m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,1,0)),
  "SA10YR.10m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,1,0)),
  "SA10YR.2m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,ifelse(SA10YR.2m.signal==1,1,0),0)),
  "SA10YR.5m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,ifelse(SA10YR.5m.signal==1,1,0),0)),  
  "SA10YR.10m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,ifelse(SA10YR.10m.signal==1,1,0),0)),
  
  "SA10YR.2m.timingret" = ifelse(SA10YR.2m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret" = ifelse(SA10YR.5m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret" = ifelse(SA10YR.10m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.2m.timingret.delayed" = ifelse(SA10YR.2m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret.delayed" = ifelse(SA10YR.5m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret.delayed" = ifelse(SA10YR.10m.signal.delayed == 1,SA10YR.ret,RF.ret),
  
  "SA10YR.avg.timingret" = (SA10YR.2m.timingret + SA10YR.5m.timingret + SA10YR.10m.timingret)/3,
  "SA10YR.avg.signal" = (SA10YR.2m.signal + SA10YR.5m.signal + SA10YR.10m.signal)/3,
  "SA10YR.avg.timingret.delayed" = (SA10YR.2m.timingret.delayed + SA10YR.5m.timingret.delayed + SA10YR.10m.timingret.delayed)/3,  
  "SA10YR.avg.signal.delayed" = (SA10YR.2m.signal.delayed + SA10YR.5m.signal.delayed + SA10YR.10m.signal.delayed)/3,  
  "SA10YR.avg.combo" = (SA10YR.avg.timingret + SA10YR.avg.timingret.delayed)/2,
  "SA10YR.avg.combo.signal" = (SA10YR.avg.signal + SA10YR.avg.signal.delayed)/2,

  "GSCI.ret" =  c(0,diff(GSCI.Close)/lag(GSCI.Close)[-1]),
  
  "GSCI.2m.SMA" =  rollmean(GSCI.Close,2,fill = 0,align = "right"),
  "GSCI.5m.SMA" =  rollmean(GSCI.Close,5,fill = 0,align = "right"),
  "GSCI.10m.SMA" =  rollmean(GSCI.Close,10,fill = 0,align = "right"),
  
  "GSCI.2m.signal" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,1,0)),
  "GSCI.5m.signal" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,1,0)),
  "GSCI.10m.signal" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,1,0)),
  "GSCI.2m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,ifelse(GSCI.2m.signal==1,1,0),0)),
  "GSCI.5m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,ifelse(GSCI.5m.signal==1,1,0),0)),  
  "GSCI.10m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,ifelse(GSCI.10m.signal==1,1,0),0)),
   
  "GSCI.2m.timingret" = ifelse(GSCI.2m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret" = ifelse(GSCI.5m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret" = ifelse(GSCI.10m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.2m.timingret.delayed" = ifelse(GSCI.2m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret.delayed" = ifelse(GSCI.5m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret.delayed" = ifelse(GSCI.10m.signal.delayed == 1,GSCI.ret,RF.ret),

  "GSCI.avg.timingret" = (GSCI.2m.timingret + GSCI.5m.timingret + GSCI.10m.timingret)/3,
  "GSCI.avg.signal" = (GSCI.2m.signal + GSCI.5m.signal + GSCI.10m.signal)/3,
  "GSCI.avg.timingret.delayed" = (GSCI.2m.timingret.delayed + GSCI.5m.timingret.delayed + GSCI.10m.timingret.delayed)/3,  
  "GSCI.avg.signal.delayed" = (GSCI.2m.signal.delayed + GSCI.5m.signal.delayed + GSCI.10m.signal.delayed)/3,  
  "GSCI.avg.combo" = (GSCI.avg.timingret + GSCI.avg.timingret.delayed)/2,
  "GSCI.avg.combo.signal" = (GSCI.avg.signal + GSCI.avg.signal.delayed)/2,

  "JASPY.ret" =  c(0,diff(JASPY.Close)/lag(JASPY.Close)[-1]),
  
  "JASPY.2m.SMA" =  rollmean(JASPY.Close,2,fill = 0,align = "right"),
  "JASPY.5m.SMA" =  rollmean(JASPY.Close,5,fill = 0,align = "right"),
  "JASPY.10m.SMA" =  rollmean(JASPY.Close,10,fill = 0,align = "right"),
  
  "JASPY.2m.signal" =  lag(ifelse(JASPY.Close>=JASPY.2m.SMA,1,0)),
  "JASPY.5m.signal" =  lag(ifelse(JASPY.Close>=JASPY.5m.SMA,1,0)),
  "JASPY.10m.signal" =  lag(ifelse(JASPY.Close>=JASPY.10m.SMA,1,0)),
  "JASPY.2m.signal.delayed" =  lag(ifelse(JASPY.Close>=JASPY.2m.SMA,ifelse(JASPY.2m.signal==1,1,0),0)),
  "JASPY.5m.signal.delayed" =  lag(ifelse(JASPY.Close>=JASPY.5m.SMA,ifelse(JASPY.5m.signal==1,1,0),0)),  
  "JASPY.10m.signal.delayed" =  lag(ifelse(JASPY.Close>=JASPY.10m.SMA,ifelse(JASPY.10m.signal==1,1,0),0)),
   
  "JASPY.2m.timingret" = ifelse(JASPY.2m.signal == 1,JASPY.ret,RF.ret),
  "JASPY.5m.timingret" = ifelse(JASPY.5m.signal == 1,JASPY.ret,RF.ret),
  "JASPY.10m.timingret" = ifelse(JASPY.10m.signal == 1,JASPY.ret,RF.ret),
  "JASPY.2m.timingret.delayed" = ifelse(JASPY.2m.signal.delayed == 1,JASPY.ret,RF.ret),
  "JASPY.5m.timingret.delayed" = ifelse(JASPY.5m.signal.delayed == 1,JASPY.ret,RF.ret),
  "JASPY.10m.timingret.delayed" = ifelse(JASPY.10m.signal.delayed == 1,JASPY.ret,RF.ret),

  "JASPY.avg.timingret" = (JASPY.2m.timingret + JASPY.5m.timingret + JASPY.10m.timingret)/3,
  "JASPY.avg.signal" = (JASPY.2m.signal + JASPY.5m.signal + JASPY.10m.signal)/3,
  "JASPY.avg.timingret.delayed" = (JASPY.2m.timingret.delayed + JASPY.5m.timingret.delayed + JASPY.10m.timingret.delayed)/3,  
  "JASPY.avg.signal.delayed" = (JASPY.2m.signal.delayed + JASPY.5m.signal.delayed + JASPY.10m.signal.delayed)/3,  
  "JASPY.avg.combo" = (JASPY.avg.timingret + JASPY.avg.timingret.delayed)/2,
  "JASPY.avg.combo.signal" = (JASPY.avg.signal + JASPY.avg.signal.delayed)/2,

  "JALSH.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(JALSH.Close>=(BuyBand*JALSH.2m.SMA),1,
                                        ifelse(JALSH.Close<(SellBand*JALSH.2m.SMA),0,2)))),  
  "JALSH.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(JALSH.Close>=(BuyBand*JALSH.5m.SMA),1,
                                        ifelse(JALSH.Close<(SellBand*JALSH.5m.SMA),0,2)))),  
  "JALSH.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(JALSH.Close>=(BuyBand*JALSH.10m.SMA),1,
                                        ifelse(JALSH.Close<(SellBand*JALSH.10m.SMA),0,2)))),
  
  "MSCIWORLD.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(MSCIWORLD.Close>=(BuyBand*MSCIWORLD.2m.SMA),1,
                                        ifelse(MSCIWORLD.Close<(SellBand*MSCIWORLD.2m.SMA),0,2)))),  
  "MSCIWORLD.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(MSCIWORLD.Close>=(BuyBand*MSCIWORLD.5m.SMA),1,
                                        ifelse(MSCIWORLD.Close<(SellBand*MSCIWORLD.5m.SMA),0,2)))),  
  "MSCIWORLD.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(MSCIWORLD.Close>=(BuyBand*MSCIWORLD.10m.SMA),1,
                                        ifelse(MSCIWORLD.Close<(SellBand*MSCIWORLD.10m.SMA),0,2)))),      
  
  "SA10YR.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(SA10YR.Close>=(BuyBand*SA10YR.2m.SMA),1,
                                        ifelse(SA10YR.Close<(SellBand*SA10YR.2m.SMA),0,2)))),  
  "SA10YR.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(SA10YR.Close>=(BuyBand*SA10YR.5m.SMA),1,
                                        ifelse(SA10YR.Close<(SellBand*SA10YR.5m.SMA),0,2)))),  
  "SA10YR.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(SA10YR.Close>=(BuyBand*SA10YR.10m.SMA),1,
                                        ifelse(SA10YR.Close<(SellBand*SA10YR.10m.SMA),0,2)))),

  "GSCI.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(GSCI.Close>=(BuyBand*GSCI.2m.SMA),1,
                                        ifelse(GSCI.Close<(SellBand*GSCI.2m.SMA),0,2)))),  
  "GSCI.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(GSCI.Close>=(BuyBand*GSCI.5m.SMA),1,
                                        ifelse(GSCI.Close<(SellBand*GSCI.5m.SMA),0,2)))),  
  "GSCI.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(GSCI.Close>=(BuyBand*GSCI.10m.SMA),1,
                                        ifelse(GSCI.Close<(SellBand*GSCI.10m.SMA),0,2)))),  
  
  "JASPY.2m.signal.band" =  ifelse(row_number()<=2,0,
                                    lag(ifelse(JASPY.Close>=(BuyBand*JASPY.2m.SMA),1,
                                        ifelse(JASPY.Close<(SellBand*JASPY.2m.SMA),0,2)))),  
  "JASPY.5m.signal.band" =  ifelse(row_number()<=5,0,
                                    lag(ifelse(JASPY.Close>=(BuyBand*JASPY.5m.SMA),1,
                                        ifelse(JASPY.Close<(SellBand*JASPY.5m.SMA),0,2)))),  
  "JASPY.10m.signal.band" =  ifelse(row_number()<=10,0,
                                    lag(ifelse(JASPY.Close>=(BuyBand*JASPY.10m.SMA),1,
                                        ifelse(JASPY.Close<(SellBand*JASPY.10m.SMA),0,2)))), 
  
  "BuyandHold.ret" = (JALSH.ret + MSCIWORLD.ret + SA10YR.ret + GSCI.ret + JASPY.ret)/5,
  
  "Timing.ret" = (JALSH.10m.timingret + MSCIWORLD.10m.timingret 
                  + SA10YR.10m.timingret + GSCI.10m.timingret + JASPY.10m.timingret)/5,
  "Timing.signal" = (JALSH.10m.signal + MSCIWORLD.10m.signal 
                     + SA10YR.10m.signal + GSCI.10m.signal + JASPY.10m.signal)/5,
  
  "DelayedTiming.ret" = (JALSH.10m.timingret.delayed + MSCIWORLD.10m.timingret.delayed
                         + SA10YR.10m.timingret.delayed + GSCI.10m.timingret.delayed + JASPY.10m.timingret.delayed)/5,
  "DelayedTiming.signal" = (JALSH.10m.signal.delayed + MSCIWORLD.10m.signal.delayed 
                            + SA10YR.10m.signal.delayed + GSCI.10m.signal.delayed + JASPY.10m.signal.delayed)/5,
  
  "Avg.Timing.ret" = (JALSH.avg.timingret + MSCIWORLD.avg.timingret 
                      + SA10YR.avg.timingret + GSCI.avg.timingret+ JASPY.avg.timingret)/5,
  "Avg.Timing.signal" = (JALSH.avg.signal + MSCIWORLD.avg.signal 
                         + SA10YR.avg.signal + GSCI.avg.signal + JASPY.avg.signal)/5,
  
  "Avg.DelayedTiming.ret" = (JALSH.avg.timingret.delayed + MSCIWORLD.avg.timingret.delayed + 
                            SA10YR.avg.timingret.delayed + GSCI.avg.timingret.delayed + JASPY.avg.timingret.delayed)/5,
  "Avg.DelayedTiming.signal" = (JALSH.avg.signal.delayed + MSCIWORLD.avg.signal.delayed + 
                            SA10YR.avg.signal.delayed + GSCI.avg.signal.delayed + JASPY.avg.signal.delayed)/5,
  
  "Avg.Combo.ret" = (JALSH.avg.combo + MSCIWORLD.avg.combo + 
                            SA10YR.avg.combo + GSCI.avg.combo + JASPY.avg.combo)/5,
  "Avg.Combo.signal" = (JALSH.avg.combo.signal + MSCIWORLD.avg.combo.signal + 
                            SA10YR.avg.combo.signal + GSCI.avg.combo.signal + JASPY.avg.combo.signal)/5
  
  )


# update signal for band strategy
for(i in 1:length(AllAssets.df$JALSH.10m.signal.band)){
  if(AllAssets.df$JALSH.2m.signal.band[i] == 2){AllAssets.df$JALSH.2m.signal.band[i] = AllAssets.df$JALSH.2m.signal.band[i-1]}
  if(AllAssets.df$JALSH.5m.signal.band[i] == 2){AllAssets.df$JALSH.5m.signal.band[i] = AllAssets.df$JALSH.5m.signal.band[i-1]}
  if(AllAssets.df$JALSH.10m.signal.band[i] == 2){AllAssets.df$JALSH.10m.signal.band[i] = AllAssets.df$JALSH.10m.signal.band[i-1]}
  
  if(AllAssets.df$MSCIWORLD.2m.signal.band[i] == 2){AllAssets.df$MSCIWORLD.2m.signal.band[i] = AllAssets.df$MSCIWORLD.2m.signal.band[i-1]}
  if(AllAssets.df$MSCIWORLD.5m.signal.band[i] == 2){AllAssets.df$MSCIWORLD.5m.signal.band[i] = AllAssets.df$MSCIWORLD.5m.signal.band[i-1]}
  if(AllAssets.df$MSCIWORLD.10m.signal.band[i] == 2){AllAssets.df$MSCIWORLD.10m.signal.band[i] = AllAssets.df$MSCIWORLD.10m.signal.band[i-1]}
  
  if(AllAssets.df$SA10YR.2m.signal.band[i] == 2){AllAssets.df$SA10YR.2m.signal.band[i] = AllAssets.df$SA10YR.2m.signal.band[i-1]}
  if(AllAssets.df$SA10YR.5m.signal.band[i] == 2){AllAssets.df$SA10YR.5m.signal.band[i] = AllAssets.df$SA10YR.5m.signal.band[i-1]}
  if(AllAssets.df$SA10YR.10m.signal.band[i] == 2){AllAssets.df$SA10YR.10m.signal.band[i] = AllAssets.df$SA10YR.10m.signal.band[i-1]}  
  
  if(AllAssets.df$GSCI.2m.signal.band[i] == 2){AllAssets.df$GSCI.2m.signal.band[i] = AllAssets.df$GSCI.2m.signal.band[i-1]}
  if(AllAssets.df$GSCI.5m.signal.band[i] == 2){AllAssets.df$GSCI.5m.signal.band[i] = AllAssets.df$GSCI.5m.signal.band[i-1]}
  if(AllAssets.df$GSCI.10m.signal.band[i] == 2){AllAssets.df$GSCI.10m.signal.band[i] = AllAssets.df$GSCI.10m.signal.band[i-1]}
  
  if(AllAssets.df$JASPY.2m.signal.band[i] == 2){AllAssets.df$JASPY.2m.signal.band[i] = AllAssets.df$JASPY.2m.signal.band[i-1]}
  if(AllAssets.df$JASPY.5m.signal.band[i] == 2){AllAssets.df$JASPY.5m.signal.band[i] = AllAssets.df$JASPY.5m.signal.band[i-1]}
  if(AllAssets.df$JASPY.10m.signal.band[i] == 2){AllAssets.df$JASPY.10m.signal.band[i] = AllAssets.df$JASPY.10m.signal.band[i-1]}
}

#calculat returns for band strategy

AllAssets.df  <- mutate(AllAssets.df,

  "JALSH.2m.timingret.band" = ifelse(JALSH.2m.signal.band == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret.band" = ifelse(JALSH.5m.signal.band == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret.band" = ifelse(JALSH.10m.signal.band == 1,JALSH.ret,RF.ret),
  
  "JALSH.avg.timingret.band" = (JALSH.2m.timingret.band + JALSH.5m.timingret.band + JALSH.10m.timingret.band)/3,  
  "JALSH.avg.signal.band" = (JALSH.2m.signal.band + JALSH.5m.signal.band + JALSH.10m.signal.band)/3, 

  "JALSH.avg.combo.band" = (JALSH.avg.timingret + JALSH.avg.timingret.delayed  + JALSH.avg.timingret.band)/3,
  "JALSH.avg.combo.band.signal" = (JALSH.avg.signal + JALSH.avg.signal.delayed + JALSH.avg.signal.band)/3,

  "MSCIWORLD.2m.timingret.band" = ifelse(MSCIWORLD.2m.signal.band == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret.band" = ifelse(MSCIWORLD.5m.signal.band == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret.band" = ifelse(MSCIWORLD.10m.signal.band == 1,MSCIWORLD.ret,RF.ret),
  
  "MSCIWORLD.avg.timingret.band" = (MSCIWORLD.2m.timingret.band + MSCIWORLD.5m.timingret.band + MSCIWORLD.10m.timingret.band)/3,  
  "MSCIWORLD.avg.signal.band" = (MSCIWORLD.2m.signal.band + MSCIWORLD.5m.signal.band + MSCIWORLD.10m.signal.band)/3, 

  "MSCIWORLD.avg.combo.band" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed  + MSCIWORLD.avg.timingret.band)/3,
  "MSCIWORLD.avg.combo.band.signal" = (MSCIWORLD.avg.signal + MSCIWORLD.avg.signal.delayed + MSCIWORLD.avg.signal.band)/3,
  
  "SA10YR.2m.timingret.band" = ifelse(SA10YR.2m.signal.band == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret.band" = ifelse(SA10YR.5m.signal.band == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret.band" = ifelse(SA10YR.10m.signal.band == 1,SA10YR.ret,RF.ret),
  
  "SA10YR.avg.timingret.band" = (SA10YR.2m.timingret.band + SA10YR.5m.timingret.band + SA10YR.10m.timingret.band)/3,  
  "SA10YR.avg.signal.band" = (SA10YR.2m.signal.band + SA10YR.5m.signal.band + SA10YR.10m.signal.band)/3, 

  "SA10YR.avg.combo.band" = (SA10YR.avg.timingret + SA10YR.avg.timingret.delayed  + SA10YR.avg.timingret.band)/3,
  "SA10YR.avg.combo.band.signal" = (SA10YR.avg.signal + SA10YR.avg.signal.delayed + SA10YR.avg.signal.band)/3,
  
  "GSCI.2m.timingret.band" = ifelse(GSCI.2m.signal.band == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret.band" = ifelse(GSCI.5m.signal.band == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret.band" = ifelse(GSCI.10m.signal.band == 1,GSCI.ret,RF.ret),
  
  "GSCI.avg.timingret.band" = (GSCI.2m.timingret.band + GSCI.5m.timingret.band + GSCI.10m.timingret.band)/3,  
  "GSCI.avg.signal.band" = (GSCI.2m.signal.band + GSCI.5m.signal.band + GSCI.10m.signal.band)/3, 

  "GSCI.avg.combo.band" = (GSCI.avg.timingret + GSCI.avg.timingret.delayed  + GSCI.avg.timingret.band)/3,
  "GSCI.avg.combo.band.signal" = (GSCI.avg.signal + GSCI.avg.signal.delayed + GSCI.avg.signal.band)/3,
  
  "JASPY.2m.timingret.band" = ifelse(JASPY.2m.signal.band == 1,JASPY.ret,RF.ret),
  "JASPY.5m.timingret.band" = ifelse(JASPY.5m.signal.band == 1,JASPY.ret,RF.ret),
  "JASPY.10m.timingret.band" = ifelse(JASPY.10m.signal.band == 1,JASPY.ret,RF.ret),
  
  "JASPY.avg.timingret.band" = (JASPY.2m.timingret.band + JASPY.5m.timingret.band + JASPY.10m.timingret.band)/3,  
  "JASPY.avg.signal.band" = (JASPY.2m.signal.band + JASPY.5m.signal.band + JASPY.10m.signal.band)/3, 

  "JASPY.avg.combo.band" = (JASPY.avg.timingret + JASPY.avg.timingret.delayed  + JASPY.avg.timingret.band)/3,
  "JASPY.avg.combo.band.signal" = (JASPY.avg.signal + JASPY.avg.signal.delayed + JASPY.avg.signal.band)/3,

  "BandTiming.ret" = (JALSH.10m.timingret.band + MSCIWORLD.10m.timingret.band
                         + SA10YR.10m.timingret.band + GSCI.10m.timingret.band + JASPY.10m.timingret.band)/5,
  "BandTiming.signal" = (JALSH.10m.signal.band + MSCIWORLD.10m.signal.band
                            + SA10YR.10m.signal.band + GSCI.10m.signal.band + JASPY.10m.signal.band)/5,

  "Avg.BandTiming.ret" = (JALSH.avg.timingret.band + MSCIWORLD.avg.timingret.band +
                            SA10YR.avg.timingret.band + GSCI.avg.timingret.band + JASPY.avg.timingret.band)/5,
  "Avg.BandTiming.signal" = (JALSH.avg.signal.band + MSCIWORLD.avg.signal.band +
                            SA10YR.avg.signal.band + GSCI.avg.signal.band + JASPY.avg.signal.band)/5,

  "Avg.Combo.Band.ret" = (JALSH.avg.combo.band + MSCIWORLD.avg.combo.band +
                            SA10YR.avg.combo.band + GSCI.avg.combo.band + JASPY.avg.combo.band)/5,
  "Avg.Combo.Band.signal" = (JALSH.avg.combo.band.signal + MSCIWORLD.avg.combo.band.signal +
                            SA10YR.avg.combo.band.signal + GSCI.avg.combo.band.signal + JASPY.avg.combo.band.signal)/5,

  #put in WMAF / SAMAF
  "WMAF.BuyandHold.ret" = (JALSH.ret * 0.225 
                           +MSCIWORLD.ret * 0.225 
                           +SA10YR.ret * 0.225 
                           +GSCI.ret * 0.1 
                           +JASPY.ret * 0.225),
  
  "WMAF.Timing.ret" = (JALSH.10m.timingret * 0.225 
                       +MSCIWORLD.10m.timingret * 0.225 
                       +SA10YR.10m.timingret * 0.225 
                       +GSCI.10m.timingret * 0.1 
                       +JASPY.10m.timingret * 0.225 ),
  
  "WMAF.Timing.signal" = (JALSH.10m.signal * 0.225 
                          +MSCIWORLD.10m.signal * 0.225 
                          +SA10YR.10m.signal * 0.225 
                          +GSCI.10m.signal * 0.1 
                          +JASPY.10m.signal * 0.225 ),
  
  "WMAF.Avg.Combo.Band.ret" = (JALSH.avg.combo.band * 0.225 
                               +MSCIWORLD.avg.combo.band * 0.225 
                               +SA10YR.avg.combo.band * 0.225 
                               +GSCI.avg.combo.band * 0.1 
                               +JASPY.avg.combo.band * 0.225 ),
  
  "WMAF.Avg.Combo.Band.signal" = (JALSH.avg.combo.band.signal * 0.225 
                                  +MSCIWORLD.avg.combo.band.signal * 0.225 
                                  +SA10YR.avg.combo.band.signal * 0.225 
                                  +GSCI.avg.combo.band.signal * 0.1 
                                  +JASPY.avg.combo.band.signal * 0.225 ),
  
  "SAMAF.BuyandHold.ret" = (JALSH.ret * 0.20 
                           +MSCIWORLD.ret * 0.20 
                           +SA10YR.ret * 0.25 
                           +GSCI.ret * 0.1 
                           +JASPY.ret * 0.25),
  
  "SAMAF.Timing.ret" = (JALSH.10m.timingret * 0.20 
                       +MSCIWORLD.10m.timingret * 0.20 
                       +SA10YR.10m.timingret * 0.25 
                       +GSCI.10m.timingret * 0.1 
                       +JASPY.10m.timingret * 0.25 ),
  
  "SAMAF.Timing.signal" = (JALSH.10m.signal * 0.20
                          +MSCIWORLD.10m.signal * 0.20 
                          +SA10YR.10m.signal * 0.25 
                          +GSCI.10m.signal * 0.1 
                          +JASPY.10m.signal * 0.25 ),
  
  "SAMAF.Avg.Combo.Band.ret" = (JALSH.avg.combo.band * 0.20 
                               +MSCIWORLD.avg.combo.band * 0.20 
                               +SA10YR.avg.combo.band * 0.25 
                               +GSCI.avg.combo.band * 0.1 
                               +JASPY.avg.combo.band * 0.25 ),
  
  "SAMAF.Avg.Combo.Band.signal" = (JALSH.avg.combo.band.signal * 0.20 
                                  +MSCIWORLD.avg.combo.band.signal * 0.15 
                                  +SA10YR.avg.combo.band.signal * 0.25 
                                  +GSCI.avg.combo.band.signal * 0.1 
                                  +JASPY.avg.combo.band.signal * 0.25 )
  

  )


rownames(AllAssets.df) <- index(AllAssets)

#Create xts of calculations to analyse performance
AllAssets.xts <- xts(AllAssets.df[,-1], order.by = AllAssets.df$date)

#detach the packagae dplyr as it isn't compatible with other packages?
detach(package:dplyr)
```

#### Individual Asset Class Strategy Comparisons and Stats

```{r}
#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLYIELDS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

FormatMultiplier <- 100

Strategies <- c("B&H","Timing","Timing Delayed","Timing Band","Multi Timing","Multi Strat")

PerformanceMeasures <- c("CAGR","Volatility","Skew","Kurtosis","Inflation CAGR","% in the Market","% positive Months","Best Month","Worst Month","Max Drawdown","Max Drawdown / CAGR",paste("Sharpe Ratio (",round(100*Return.annualized(Return.calculate(TBILLS)[SubsetPeriod.Reporting]),2),"%)", sep = ""),"Sortino Ratio","MAR Ratio","Ulcer Index")

```

#### JASPY

```{r}
Returns <- cbind.xts(AllAssets.xts$JASPY.ret, 
                     AllAssets.xts$JASPY.10m.timingret, 
                     AllAssets.xts$JASPY.10m.timingret.delayed,
                     AllAssets.xts$JASPY.10m.timingret.band,
                     AllAssets.xts$JASPY.avg.timingret,
                     AllAssets.xts$JASPY.avg.combo.band)[SubsetPeriod.Reporting]

colnames(Returns) <- Strategies

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Strategy Returns, 1994-2016, Log Scale",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Strategy Drawdowns, 1994-2016, Log Scale",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JASPY.10m.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JASPY.10m.signal.delayed[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JASPY.10m.signal.band[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JASPY.avg.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$JASPY.avg.combo.band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- Strategies

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
write.table(round(Returns,4), "clipboard", sep="\t", col.names=NA)
```

#### GTAA


```{r}
Returns <- cbind.xts(AllAssets.xts$BuyandHold.ret,
                     AllAssets.xts$Timing.ret,
                     AllAssets.xts$DelayedTiming.ret,
                     AllAssets.xts$BandTiming.ret,
                     AllAssets.xts$Avg.Timing.ret,
                     AllAssets.xts$Avg.Combo.Band.ret)[SubsetPeriod.Reporting]

colnames(Returns) <- Strategies

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Systematic Tactical Asset Allocation Strategy Returns, 1994-2016",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Systematic Tactical Asset Allocation Strategy Drawdowns, 1994-2016",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$DelayedTiming.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$BandTiming.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$Avg.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$Avg.Combo.Band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- Strategies

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
write.table(round(Returns,4), "clipboard", sep="\t", col.names=NA)
```


#### GTAA for SAMAF
```{r}
Returns <- cbind.xts(AllAssets.xts$SAMAF.BuyandHold.ret,
                     AllAssets.xts$SAMAF.Timing.ret,
                     AllAssets.xts$SAMAF.Avg.Combo.Band.ret)[SubsetPeriod.Reporting]

colnames(Returns) <- c("B&H","Timing","Multi")

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Systematic Tactical Asset Allocation Strategy Returns, 1994-2016",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Systematic Tactical Asset Allocation Strategy Drawdowns, 1994-2016",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$WMAF.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$WMAF.Avg.Combo.Band.signal[SubsetPeriod.Reporting]),
                  nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SAMAF.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SAMAF.Avg.Combo.Band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- colnames(Returns)

PerformanceMeasures <- c("CAGR","Volatility","Skew","Kurtosis","Inflation CAGR","% in the Market","% positive Months","Best Month","Worst Month","Max Drawdown","Max Drawdown / CAGR",paste("Sharpe Ratio (",round(100*Return.annualized(Return.calculate(TBILLS)[SubsetPeriod.Reporting]),2),"%)", sep = ""),"Sortino Ratio","MAR Ratio","Ulcer Index")

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
```




#### GTAA for SAMAF with funds
```{r}
#Define subset dates for different period
SubsetPeriod.Reporting <- "2003-12-31::2016-12-31"
SubsetPeriod.Calculations <- "2002-01-31::2016-12-31"

getSymbols(c("ALSTABL","PRUINFA"),
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))


AllAssets2 <- cbind.xts(Cl(ALSTABL),
                       Cl(PRUINFA))                       

AllAssets2 <- AllAssets2[SubsetPeriod.Calculations]
colnames(AllAssets2) <- c("ALSTABL","PRUINFA")

#calculate returns and cum returns
AllAssets2.ret <- Return.calculate(AllAssets2)[-1,]
AllAssets2.cumret <- 100*cumprod(1+ ROC(AllAssets2, type = "discrete")[-1,])
```



```{r}
Returns <- cbind.xts(AllAssets.xts$SAMAF.BuyandHold.ret,
                     AllAssets.xts$SAMAF.Timing.ret,
                     AllAssets.xts$SAMAF.Avg.Combo.Band.ret,
                     AllAssets2.ret$ALSTABL,
                     AllAssets2.ret$PRUINFA)[SubsetPeriod.Reporting]

colnames(Returns) <- c("B&H","Timing","Multi","ALSTABL","PRUINFA")

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Systematic Tactical Asset Allocation Strategy Returns, 1994-2016",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Systematic Tactical Asset Allocation Strategy Drawdowns, 1994-2016",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$WMAF.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$WMAF.Avg.Combo.Band.signal[SubsetPeriod.Reporting]),
                  nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SAMAF.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SAMAF.Avg.Combo.Band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- colnames(Returns)

PerformanceMeasures <- c("CAGR","Volatility","Skew","Kurtosis","Inflation CAGR","% in the Market","% positive Months","Best Month","Worst Month","Max Drawdown","Max Drawdown / CAGR",paste("Sharpe Ratio (",round(100*Return.annualized(Return.calculate(TBILLS)[SubsetPeriod.Reporting]),2),"%)", sep = ""),"Sortino Ratio","MAR Ratio","Ulcer Index")

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
```










with fees
```{r}
annualfee <- 0.01
fees <- ((1 + annualfee)^(1/12))-1

Returns <- cbind.xts(AllAssets.xts$SAMAF.BuyandHold.ret,
                     AllAssets.xts$SAMAF.Timing.ret-fees,
                     AllAssets.xts$SAMAF.Avg.Combo.Band.ret-fees,
                     AllAssets2.ret$ALSTABL,
                     AllAssets2.ret$PRUINFA)[SubsetPeriod.Reporting]

colnames(Returns) <- c("B&H","Timing","Multi","ALSTABL","PRUINFA")

chart.CumReturns(Returns, wealth.index = TRUE,
  main = "Systematic Tactical Asset Allocation Strategy Returns, 1994-2016",
  #colorset = c(4,2,3,5,6),
  legend.loc = "topleft", 
  date.format = "%Y", ylab = "", ylog = TRUE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = "Systematic Tactical Asset Allocation Strategy Drawdowns, 1994-2016",
  date.format = "%Y", 
  #colorset = c(4,2,3,5,6),
  ylab = "Drawdown", legend.loc = "bottomright", major.ticks = "years",  minor.ticks = FALSE)

TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$WMAF.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$WMAF.Avg.Combo.Band.signal[SubsetPeriod.Reporting]),
                  nrow(AllAssets.xts[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SAMAF.Timing.signal[SubsetPeriod.Reporting]),
                  sum(AllAssets.xts$SAMAF.Avg.Combo.Band.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- colnames(Returns)

PerformanceMeasures <- c("CAGR","Volatility","Skew","Kurtosis","Inflation CAGR","% in the Market","% positive Months","Best Month","Worst Month","Max Drawdown","Max Drawdown / CAGR",paste("Sharpe Ratio (",round(100*Return.annualized(Return.calculate(TBILLS)[SubsetPeriod.Reporting]),2),"%)", sep = ""),"Sortino Ratio","MAR Ratio","Ulcer Index")

rownames(FullStats) <- PerformanceMeasures

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)

write.table(round(Returns,5), "clipboard", sep="\t", col.names=NA)
```




```{r}

chart.RollingPerformance(Returns[,1:3],
                         width = 12,
                         main = "WMAF Strategy Rolling 12-month Annualised Return",
                         legend.loc = "topleft")

chart.RollingPerformance(Returns$'WMAF Multi'-Returns$'WMAF B&H', 
                         width = 12,
                         main = "WMAF Multi less WMAF B&H Rolling 12-month Annualised Return"
                         )

chart.RollingPerformance(Returns[,4:6],
                         width = 12,
                         main = "SAMAF Strategy Rolling 12-month Annualised Return",
                         legend.loc = "topleft")


chart.RollingPerformance(Returns$'SAMAF Multi'-Returns$'SAMAF B&H', 
                         width = 12,
                         main = "SAMAF Multi less SAMAF B&H Rolling 12-month Annualised Return"
                         )

table.CalendarReturns(Returns$'SAMAF Multi'["1994::2016"])[13]


```






























































####Example of benefit of averaging timing signals

```{r}
#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLYIELDS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

#Get Returns
Returns <- cbind.xts(AllAssets.xts$MSCIWORLD.ret, 
                     AllAssets.xts$MSCIWORLD.2m.timingret, 
                     AllAssets.xts$MSCIWORLD.5m.timingret,
                     AllAssets.xts$MSCIWORLD.10m.timingret,
                     AllAssets.xts$MSCIWORLD.avg.timingret)[SubsetPeriod.Reporting]

#Time in market
TimeInMarket <- c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
  sum(AllAssets.xts$MSCIWORLD.2m.signal[SubsetPeriod.Reporting]),
  sum(AllAssets.xts$MSCIWORLD.5m.signal[SubsetPeriod.Reporting]),
  sum(AllAssets.xts$MSCIWORLD.10m.signal[SubsetPeriod.Reporting]),
  sum(AllAssets.xts$MSCIWORLD.avg.signal[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])

FormatMultiplier <- 100

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier, 
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- c("B&H","2M Timing","5M Timing","10M Timing","Avg Timing")

rownames(FullStats) <- c("CAGR","Volatility","Skew","Kurtosis","Inflation CAGR","% in the Market","% positive Months","Best Month","Worst Month","Max Drawdown","Max Drawdown / CAGR",paste("Sharpe Ratio (",round(100*Return.annualized(Return.calculate(TBILLS)[SubsetPeriod.Reporting]),2),"%)", sep = ""),"Sortino Ratio","MAR Ratio","Ulcer Index")

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
#how do i get a distribution chart to check skew/kurtosis
```

### compare delayed to normal to see benefits of avoiding whipsaws
```{r}
#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLYIELDS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

Returns <- cbind.xts(AllAssets.xts$JALSH.10m.timingret,
                     AllAssets.xts$JALSH.10m.timingret.delayed)[SubsetPeriod.Reporting]

#Time in market
TimeInMarket <- c(sum(AllAssets.xts$JALSH.10m.signal[SubsetPeriod.Reporting]),
  sum(AllAssets.xts$JALSH.10m.signal.delayed[SubsetPeriod.Reporting]))/nrow(AllAssets.xts[SubsetPeriod.Reporting])
  
FormatMultiplier <- 100

FullStats <- rbind(Return.annualized(Returns,scale = 12)*FormatMultiplier, 
                   StdDev.annualized(Returns,scale = 12)*FormatMultiplier,
                   skewness(Returns),
                   kurtosis(Returns),
                   100*c(Return.annualized(AllAssets.ret$SACPI[SubsetPeriod.Reporting],scale = 12)),
                   TimeInMarket*FormatMultiplier,
                   apply(Returns, 2, function(x) length(x[x>0]))/nrow(Returns)*FormatMultiplier,
                   apply(Returns, 2, function(x) max(x, na.rm = TRUE))*FormatMultiplier,
                   apply(Returns, 2, function(x) min(x, na.rm = TRUE))*FormatMultiplier,
                   maxDrawdown(Returns,scale = 12,invert = FALSE)*FormatMultiplier,
                   -maxDrawdown(Returns,scale = 12,invert = FALSE)/Return.annualized(Returns,scale = 12),
                   SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS[SubsetPeriod.Reporting]),
                   SortinoRatio(Returns, scale = 12), #what MAR?
                   CalmarRatio(Returns, scale = 12),
                   UlcerIndex(Returns)*FormatMultiplier)

colnames(FullStats) <- c("Timing","Delayed Timing")

rownames(FullStats) <- c("CAGR","Volatility","Skew","Kurtosis","Inflation CAGR","% in the Market","% positive Months","Best Month","Worst Month","Max Drawdown","Max Drawdown / CAGR",paste("Sharpe Ratio (",round(100*Return.annualized(Return.calculate(TBILLS)[SubsetPeriod.Reporting]),2),"%)", sep = ""),"Sortino Ratio","MAR Ratio","Ulcer Index")

round(FullStats,2)
write.table(round(FullStats,4), "clipboard", sep="\t", col.names=NA)
#how do i get a distribution chart to check skew/kurtosis
```


```{r}
chart.RollingPerformance(Returns$"10m Timing Delayed"-Returns$"10m Timing", 
                         width = 3,
                         main = "Rolling Perf"
                         )

```

```{r}
chart_Series(Cl(SA10YR),
  name = paste("SA10YR vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = "1983::1986-06",
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )
```

so better sharpe? [confirm calc method/fix interest rate... should i calc manually?] and less maxdd
whats kurtosis, information ratio, skew. ask what metrics rad, mb and emyln use...
run on longer dater in asset allocation ratios

last 12 months, 3 years, etc returns

rolling returns

to do:

* how to calculate dailyreturns with NA
* check returns make sense - effect of zar?
* compare to US / JPY
* create RF to get 2002 in

To do:
SA assets
Daily drawdowns
monthly returns table
Relative performance / rolling perofrmance / alpha
10 worst periods / 10 best periods 
do different averages improve SA - check robustness of averages....