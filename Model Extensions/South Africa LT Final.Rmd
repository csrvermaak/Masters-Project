---
title: "Replication of Faber's A Quantitative Approach to Tactical Asset Allocation - South Africa"
output: html_notebook
---

####Importing the data into R

Each asset's class price series has been saved as a CSV. The packages used for performance analysis and backtesting require the data to be xts objects which are created by the following code.

```{r, message=FALSE, warning=FALSE}
#remove past data
rm(list = ls(envir = globalenv()),envir = globalenv()) #clear Vars from global enviroment

#Load required packages
library(PerformanceAnalytics)
library(quantstrat)

#Set Symbols
symbols <- c("TBILLS","JALSH","MSCIWORLD","SA10YR","GSCI","JASPY","SACPI")

#Import saved pricing data csv files as xts
getSymbols(symbols,
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#Define subset dates for different period
SubsetPeriod.Reporting <- "1971-12-31::2016-12-31"
SubsetPeriod.Calculations <- "1971-01-31::2016-12-31"
```

#### Calculating asset class returns and charting

Once the data is loaded we can create one xts object for the prices and calculate each asset class's returns. The asset class returns are then charted.
```{r}
AllAssets <- cbind.xts(Cl(TBILLS),
                       Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       #Cl(JSAPY),
                       Cl(SACPI))                       

AllAssets <- AllAssets[SubsetPeriod.Reporting]
colnames(AllAssets) <- symbols[-6]

#calculate returns and cum returns
AllAssets.ret <- Return.calculate(AllAssets)[-1,]
AllAssets.cumret <- 100*cumprod(1+ ROC(AllAssets, type = "discrete")[-1,])
#how do i add a row at the top with value of 100 for each? rbind?

chart.TimeSeries(AllAssets.cumret[SubsetPeriod.Reporting],
 main = paste("Figure X - SA Asset Class Returns, Log Scale",sep = ""),
 ylab = "",
 #ylog = TRUE,
 ylim = c(100,250000),
 #date.format = "%Y",
 major.ticks = "years",
 legend.loc = "topleft",
 colorset = c("orangered3","olivedrab","slateblue","blue","gold2","dodgerblue2","cornflowerblue")
 #minor.ticks =FALSE
 )

#how do i change scale format!
```


####Analysing asset class returns, max drawdowns and other performance statistics

Using the package performance analytics, common performance statistics such as CAGR, volatility and sharpe ratios can be calculated.
```{r}
#Create xts for Returns
Returns <- AllAssets.ret[SubsetPeriod.Reporting]

#calculate statistics and store as "stats"
stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS),
               100*maxDrawdown(Returns,scale = 12,invert = FALSE),
               100*c(Return.annualized(Returns$SACPI,scale = 12)))

#rename table rows/column names and format
colnames(stats) <- symbols[-6]
rownames(stats) <- c("Return",
                     "Volatility",
                     paste("Sharpe (",round(stats[1,"TBILLS"],2),"%)", sep = ""),
                     "MaxDD",
                     "Inflation CAGR")

stats <- round(stats[,-6],2) #delete inflation column - change to 7 when including property.

#print
stats

#copies stats to clipboad for pasting into word/excel
#write.table(stats, "clipboard", sep="\t", col.names=NA) 
```

####Managing Risk 

Lets chart each asset with its 10 month simple moving average

```{r}
myChart_Theme <- chart_theme() #Create a chart_theme
myChart_Theme$col$line.col <- "blue"

SMAperiod <- 10

chart_Series(Cl(JALSH),
  name = paste("JALSH vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(MSCIWORLD),
  name = paste("MSCI World vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(SA10YR),
  name = paste("SA10YR vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(GSCI),
  name = paste("GSCI vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

#change to other chart so can make it log?
```

####Calculating returns

```{r, message=FALSE, warning=FALSE}
#Import saved pricing data csv files as xts
getSymbols("TBILLYIELDS",
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#load an additional library
library(dplyr)

#Create new all assets
AllAssets <- cbind.xts(Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       Cl(TBILLYIELDS))   

AllAssets <- AllAssets[SubsetPeriod.Calculations]

#create dataframe - tidyverse not compatible with xts?
AllAssets.df <- data.frame(date=index(AllAssets), coredata(AllAssets)) #, row.names = index(AllAssets))

bandwidth <- 0.02
#mutate new columns
AllAssets.df  <- mutate(AllAssets.df,
  "RF.ret" =  c(0,lag((TBILLYIELDS.Close/100)/12)[-1]), 
  #is this right?

  "JALSH.ret" =  c(0,diff(JALSH.Close)/lag(JALSH.Close)[-1]),
  
  "JALSH.2m.SMA" =  rollmean(JALSH.Close,2,fill = 0,align = "right"),
  "JALSH.5m.SMA" =  rollmean(JALSH.Close,5,fill = 0,align = "right"),
  "JALSH.10m.SMA" =  rollmean(JALSH.Close,10,fill = 0,align = "right"),
  
  "JALSH.2m.signal" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,1,0)),
  "JALSH.5m.signal" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,1,0)),
  "JALSH.10m.signal" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,1,0)),
  "JALSH.2m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,ifelse(JALSH.2m.signal==1,1,0),0)),
  "JALSH.5m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,ifelse(JALSH.5m.signal==1,1,0),0)),  
  "JALSH.10m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,ifelse(JALSH.10m.signal==1,1,0),0)),
  
  "JALSH.2m.timingret" = ifelse(JALSH.2m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret" = ifelse(JALSH.5m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret" = ifelse(JALSH.10m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.2m.timingret.delayed" = ifelse(JALSH.2m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret.delayed" = ifelse(JALSH.5m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret.delayed" = ifelse(JALSH.10m.signal.delayed == 1,JALSH.ret,RF.ret),
 
  "JALSH.avg.timingret" = (JALSH.2m.timingret + JALSH.5m.timingret + JALSH.10m.timingret)/3,
  "JALSH.avg.timingret.delayed" = (JALSH.2m.timingret.delayed + JALSH.5m.timingret.delayed + JALSH.10m.timingret.delayed)/3,  
  "JALSH.avg.combo" = (JALSH.avg.timingret + JALSH.avg.timingret.delayed)/2,

  "MSCIWORLD.ret" =  c(0,diff(MSCIWORLD.Close)/lag(MSCIWORLD.Close)[-1]),
  
  "MSCIWORLD.2m.SMA" =  rollmean(MSCIWORLD.Close,2,fill = 0,align = "right"),
  "MSCIWORLD.5m.SMA" =  rollmean(MSCIWORLD.Close,5,fill = 0,align = "right"),
  "MSCIWORLD.10m.SMA" =  rollmean(MSCIWORLD.Close,10,fill = 0,align = "right"),
  
  "MSCIWORLD.2m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,1,0)),
  "MSCIWORLD.5m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,1,0)),
  "MSCIWORLD.10m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,1,0)),
  "MSCIWORLD.2m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,ifelse(MSCIWORLD.2m.signal==1,1,0),0)),
  "MSCIWORLD.5m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,ifelse(MSCIWORLD.5m.signal==1,1,0),0)),  
  "MSCIWORLD.10m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,ifelse(MSCIWORLD.10m.signal==1,1,0),0)),
  
  "MSCIWORLD.2m.timingret" = ifelse(MSCIWORLD.2m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret" = ifelse(MSCIWORLD.5m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret" = ifelse(MSCIWORLD.10m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.2m.timingret.delayed" = ifelse(MSCIWORLD.2m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret.delayed" = ifelse(MSCIWORLD.5m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret.delayed" = ifelse(MSCIWORLD.10m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  
  "MSCIWORLD.avg.timingret" = (MSCIWORLD.2m.timingret + MSCIWORLD.5m.timingret + MSCIWORLD.10m.timingret)/3,
  "MSCIWORLD.avg.timingret.delayed" = (MSCIWORLD.2m.timingret.delayed + MSCIWORLD.5m.timingret.delayed + MSCIWORLD.10m.timingret.delayed)/3,
  "MSCIWORLD.avg.combo" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed)/2,
    
  "SA10YR.ret" =  c(0,diff(SA10YR.Close)/lag(SA10YR.Close)[-1]),
  
  "SA10YR.2m.SMA" =  rollmean(SA10YR.Close,2,fill = 0,align = "right"),
  "SA10YR.5m.SMA" =  rollmean(SA10YR.Close,5,fill = 0,align = "right"),
  "SA10YR.10m.SMA" =  rollmean(SA10YR.Close,10,fill = 0,align = "right"),
  
  "SA10YR.2m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,1,0)),
  "SA10YR.5m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,1,0)),
  "SA10YR.10m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,1,0)),
  "SA10YR.2m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,ifelse(SA10YR.2m.signal==1,1,0),0)),
  "SA10YR.5m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,ifelse(SA10YR.5m.signal==1,1,0),0)),  
  "SA10YR.10m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,ifelse(SA10YR.10m.signal==1,1,0),0)),
  
  "SA10YR.2m.timingret" = ifelse(SA10YR.2m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret" = ifelse(SA10YR.5m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret" = ifelse(SA10YR.10m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.2m.timingret.delayed" = ifelse(SA10YR.2m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret.delayed" = ifelse(SA10YR.5m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret.delayed" = ifelse(SA10YR.10m.signal.delayed == 1,SA10YR.ret,RF.ret),
  
  "SA10YR.avg.timingret" = (SA10YR.2m.timingret + SA10YR.5m.timingret + SA10YR.10m.timingret)/3,
  "SA10YR.avg.timingret.delayed" = (SA10YR.2m.timingret.delayed + SA10YR.5m.timingret.delayed + SA10YR.10m.timingret.delayed)/3,
  "SA10YR.avg.combo" = (SA10YR.avg.timingret + SA10YR.avg.timingret.delayed)/2,
  
  "GSCI.ret" =  c(0,diff(GSCI.Close)/lag(GSCI.Close)[-1]),
  
  "GSCI.2m.SMA" =  rollmean(GSCI.Close,2,fill = 0,align = "right"),
  "GSCI.5m.SMA" =  rollmean(GSCI.Close,5,fill = 0,align = "right"),
  "GSCI.10m.SMA" =  rollmean(GSCI.Close,10,fill = 0,align = "right"),
  
  "GSCI.2m.signal" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,1,0)),
  "GSCI.5m.signal" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,1,0)),
  "GSCI.10m.signal" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,1,0)),
  "GSCI.2m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,ifelse(GSCI.2m.signal==1,1,0),0)),
  "GSCI.5m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,ifelse(GSCI.5m.signal==1,1,0),0)),  
  "GSCI.10m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,ifelse(GSCI.10m.signal==1,1,0),0)),
   
  "GSCI.2m.timingret" = ifelse(GSCI.2m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret" = ifelse(GSCI.5m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret" = ifelse(GSCI.10m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.2m.timingret.delayed" = ifelse(GSCI.2m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret.delayed" = ifelse(GSCI.5m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret.delayed" = ifelse(GSCI.10m.signal.delayed == 1,GSCI.ret,RF.ret),

  "GSCI.avg.timingret" = (GSCI.2m.timingret + GSCI.5m.timingret + GSCI.10m.timingret)/3,
  "GSCI.avg.timingret.delayed" = (GSCI.2m.timingret.delayed + GSCI.5m.timingret.delayed + GSCI.10m.timingret.delayed)/3,
  "GSCI.avg.combo" = (GSCI.avg.timingret + GSCI.avg.timingret.delayed)/2,

  "BuyandHold.ret" = (JALSH.ret + MSCIWORLD.ret + SA10YR.ret + GSCI.ret)/4,
  "Timing.ret" = (JALSH.10m.timingret + MSCIWORLD.10m.timingret + SA10YR.10m.timingret + GSCI.10m.timingret)/4,
  "DelayedTiming.ret" = (JALSH.10m.timingret.delayed + MSCIWORLD.10m.timingret.delayed + SA10YR.10m.timingret.delayed + GSCI.10m.timingret.delayed)/4,
  "Avg.Timing.ret" = (JALSH.avg.timingret + MSCIWORLD.avg.timingret + SA10YR.avg.timingret + GSCI.avg.timingret)/4,
  "Avg.DelayedTiming.ret" = (JALSH.avg.timingret.delayed + MSCIWORLD.avg.timingret.delayed + 
                            SA10YR.avg.timingret.delayed + GSCI.avg.timingret.delayed)/4,
  "Avg.Combo.ret" = (JALSH.avg.combo + MSCIWORLD.avg.combo + 
                            SA10YR.avg.combo + GSCI.avg.combo)/4
  
  )

rownames(AllAssets.df) <- index(AllAssets)

#Create xts of calculations to analyse performance
AllAssets.xts <- xts(AllAssets.df[,-1], order.by = AllAssets.df$date)

#detach the packagae dplyr as it isn't compatible with other packages?
detach(package:dplyr)
```

#### Individual Asset Class Comparisons

```{r}
#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLYIELDS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

#MSCI World
Returns <- cbind.xts(AllAssets.xts$JALSH.ret, 
                     AllAssets.xts$JALSH.10m.timingret, 
                     AllAssets.xts$JALSH.10m.timingret.delayed, 
                     AllAssets.xts$JALSH.avg.timingret,
                     AllAssets.xts$JALSH.avg.timingret.delayed,
                     AllAssets.xts$JALSH.avg.combo)[SubsetPeriod.Reporting]

CumReturns <- 100*cumprod(1+Returns[-1,])
colnames(CumReturns) <- c("Buy and Hold","Timing","Timing Delayed","Avg Timing","Avg Timing Delayed","Avg Combo")
colnames(Returns) <- c("Buy and Hold","Timing","Timing Delayed","Avg Timing","Avg Timing Delayed","Avg Combo")

#how do i add earlier row and make it 100

#as.numeric(substr(SubsetPeriod,1,4))+1
chart.TimeSeries(CumReturns,
  main = paste("Buy and Hold vs Timing vs Timing Avg, ",
               substr(SubsetPeriod.Reporting,1,4),"-",
               substr(SubsetPeriod.Reporting,13,16),
               ", Log Scale",sep = ""),
  date.format = "%Y",
  colorset = c(4,2,3,5,6,7),
  ylab = "",
  ylog = TRUE,
  #ylim = c(50,1000),
  legend.loc = "topleft",
  major.ticks = "years",
  minor.ticks = FALSE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = paste("Buy and Hold vs Timing vs Timing Avg",substr(SubsetPeriod.Reporting,1,4),"-",substr(SubsetPeriod.Reporting,13,16),", Non-log Scale",sep = ""),
  date.format = "%Y",
  colorset = c(4,2,3,5,6),
  ylab = "Drawdown",
  legend.loc = "bottomright",
  major.ticks = "years",
  minor.ticks = FALSE)

```

```{r}
stats <- rbind(Return.annualized(Returns,scale = 12)*100, 
               StdDev.annualized(Returns,scale = 12)*100, 
               SharpeRatio.annualized(Returns,Rf = Rf.ret$TBILLYIELDS.Close),
               maxDrawdown(Returns,scale = 12,invert = FALSE)*100,
               
               # # % Positive Months
               # 100*c(nrow(subset(Returns, Returns$'Buy and Hold' >= 0)),
               #   nrow(subset(Returns, Returns$'Timing' >= 0)),
               #   nrow(subset(Returns, Returns$'Timing Delayed' >= 0)),
               #   nrow(subset(Returns, Returns$'Avg Timing' >= 0)),
               #   nrow(subset(Returns, Returns$'Avg Timing Delayed' >= 0)))/nrow(Returns),
               # 
               # # % months invested in the market
               # 100*c(nrow(AllAssets.xts[SubsetPeriod.Reporting]),
               #   sum(AllAssets.xts$JALSH.10m.signal[SubsetPeriod.Reporting] == 1),
               #   sum(AllAssets.xts$JALSH.10m.signal.delayed[SubsetPeriod.Reporting] == 1),
               #   (sum(AllAssets.xts$JALSH.2m.signal[SubsetPeriod.Reporting] == 1) + 
               #   sum(AllAssets.xts$JALSH.5m.signal[SubsetPeriod.Reporting] == 1) + 
               #   sum(AllAssets.xts$JALSH.10m.signal[SubsetPeriod.Reporting] == 1))/3,
               #   (sum(AllAssets.xts$JALSH.2m.signal.delayed[SubsetPeriod.Reporting] == 1) + 
               #   sum(AllAssets.xts$JALSH.5m.signal.delayed[SubsetPeriod.Reporting] == 1) + 
               #   sum(AllAssets.xts$JALSH.10m.signal.delayed[SubsetPeriod.Reporting] == 1))/3)/
               #   nrow(AllAssets.xts$JALSH.10m.signal[SubsetPeriod.Reporting]),
               # 
               # # % positive months when invested in the asset
               # 100*c(
               # nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.ret >= 0))
               # /nrow(AllAssets.xts[SubsetPeriod.Reporting]),  
               # 
               # nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal == 1 & JALSH.10m.timingret >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal == 1)),
               # 
               # nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal.delayed == 1 & JALSH.10m.timingret.delayed >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal.delayed == 1)),
               # 
               # (nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.2m.signal == 1 & JALSH.2m.timingret >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.2m.signal == 1))+
               # nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.5m.signal == 1 & JALSH.5m.timingret >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.5m.signal == 1))+
               # nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal == 1 & JALSH.10m.timingret >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal == 1)))/3,
               # 
               # (nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.2m.signal.delayed == 1 & JALSH.2m.timingret.delayed >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.2m.signal.delayed == 1))+
               # nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.5m.signal.delayed == 1 & JALSH.5m.timingret.delayed >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.5m.signal.delayed == 1))+
               # nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal.delayed == 1 & JALSH.10m.timingret.delayed >= 0))
               # /nrow(subset(AllAssets.xts[SubsetPeriod.Reporting], JALSH.10m.signal.delayed == 1)))/3),
               
               # Sortino
               SortinoRatio(Returns, MAR = 0),
               
               #Information Ratio
               InformationRatio(Returns, Returns$"Buy and Hold"),
               
               #Ulcer Index
               100*UlcerIndex(Returns),
               
               #Calmar Ratio
               CalmarRatio(Returns["2014::2017"], scale = 12)
               
               )
               
colnames(stats) <- c("Buy and Hold","Timing","Timing Delayed","Average Timing","Average Timing Delayed","Avg Combo")
rownames(stats) <- c("Return",
                     "Volatility",
                     "Sharpe",
                     "MaxDD",
                     # "% Positive Months",
                     # "% Months invested in the Asset",
                     # "% Positive Months when invested",
                     "Sortino Ratio",
                     "Information Ratio",
                     "Ulcer Index",
                     "Calmar Ratio")

round(stats,2)
write.table(round(stats,4), "clipboard", sep="\t", col.names=NA)

```

####Example of benefit of averaging timing signals

```{r}
#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLYIELDS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

#Get Returns
Returns <- cbind.xts(AllAssets.xts$MSCIWORLD.ret, 
                     AllAssets.xts$MSCIWORLD.2m.timingret, 
                     AllAssets.xts$MSCIWORLD.5m.timingret,
                     AllAssets.xts$MSCIWORLD.10m.timingret,
                     AllAssets.xts$MSCIWORLD.avg.timingret)[SubsetPeriod.Reporting]

CumReturns <- 100*cumprod(1+Returns[-1,])

colnames(Returns) <- c("Buy and Hold","2m SMA Timing","5m SMA Timing","10m SMA Timing","Avg Timing")

stats <- rbind(Return.annualized(Returns,scale = 12)*100, 
               StdDev.annualized(Returns,scale = 12)*100, 
               SharpeRatio.annualized(Returns,Rf = Rf.ret$TBILLYIELDS.Close),
               maxDrawdown(Returns,scale = 12,invert = FALSE)*100,

               # Sortino
               SortinoRatio(Returns, MAR = 0),
               
               #Information Ratio
               InformationRatio(Returns, Returns$"Buy and Hold"),
               
               #Ulcer Index
               100*UlcerIndex(Returns),
               
               #Calmar Ratio
               CalmarRatio(Returns["2014::2017"], scale = 12)
               
               )

colnames(stats) <- colnames(Returns) 
rownames(stats) <- c("Return",
                     "Volatility",
                     "Sharpe",
                     "MaxDD",
                     "Sortino Ratio",
                     "Information Ratio",
                     "Ulcer Index",
                     "Calmar Ratio")

round(stats,2)
write.table(round(stats,4), "clipboard", sep="\t", col.names=NA)
```

####GTAA Performance Charts

```{r}
Returns <- cbind.xts(AllAssets.xts$BuyandHold.ret,
                     AllAssets.xts$Timing.ret,
                     AllAssets.xts$DelayedTiming.ret,
                     AllAssets.xts$Avg.Timing.ret,
                     AllAssets.xts$Avg.DelayedTiming.ret,
                     AllAssets.xts$Avg.Combo.ret)[SubsetPeriod.Reporting]

CumReturns <- 100*cumprod(1+Returns[-1,])
colnames(CumReturns) <- c("Buy & Hold","Timing","Delayed Timing","Avg Timing","Avg Delayed Timing","Avg Combo")

chart.TimeSeries(CumReturns,
  main = "Figure X - Timing Model Comparison, Log Scale",
  date.format = "%Y",
  colorset = c(4,2,3,5,6,7),
  ylab = "",
  ylog = TRUE,
  #ylim = c(100,76000),
  legend.loc = "topleft",
  major.ticks = "years",
  minor.ticks = FALSE,
  yaxis = TRUE)

chart.TimeSeries(CumReturns,
  main = "Figure X - Timing Model Comparison, Non Log Scale",
  date.format = "%Y",
  colorset = c(4,2,3,5,6),
  ylab = "",
  ylog = FALSE,
  #ylim = c(100,500),
  legend.loc = "topleft",
  major.ticks = "years",
  minor.ticks = FALSE)
```

```{r}
Rf.ret <- Return.calculate(TBILLS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

Returns <- cbind.xts(AllAssets.xts$BuyandHold.ret,
                     AllAssets.xts$Timing.ret,
                     AllAssets.xts$DelayedTiming.ret,
                     AllAssets.xts$Avg.Timing.ret,
                     AllAssets.xts$Avg.DelayedTiming.ret,
                     AllAssets.xts$Avg.Combo.ret)[SubsetPeriod.Reporting]

stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = Rf.ret$TBILLS.Close),
               100*maxDrawdown(Returns,invert = FALSE),
               100*c(Return.annualized(Return.calculate(Cl(SACPI))[SubsetPeriod.Reporting],scale = 12)),
               
               # Sortino
               SortinoRatio(Returns, MAR = 0),
               
               #Information Ratio
               InformationRatio(Returns, Returns$BuyandHold.ret),
               
               #Ulcer Index
               100*UlcerIndex(Returns),
               
               #Calmar Ratio
               CalmarRatio(Returns["2014::2017"], scale = 12)
               )

colnames(stats) <- c("Buy & Hold",
                     "Timing",
                     "Delayed Timing",
                     "Avg Timing",
                     "Avg Delayed Timing",
                     "Avg Combo")

rownames(stats) <- c("Return",
                     "Volatility",
                     "Sharpe", #what %?
                     "MaxDD",
                     "Inflation CAGR",
                     "Sortino Ratio",
                     "Information Ratio",
                     "Ulcer Index",
                     "Calmar Ratio")

round(stats,2)
#write.table(round(stats,4), "clipboard", sep="\t", col.names=NA)

```


### compare delayed to normal to see benefits of avoiding whipsaws
```{r}
Rf.ret <- Return.calculate(TBILLS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

Returns <- cbind.xts(AllAssets.xts$SA10YR.10m.timingret,
                     AllAssets.xts$SA10YR.10m.timingret.delayed)[SubsetPeriod.Reporting]

colnames(Returns) <- c("10m Timing","10m Timing Delayed")

stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = Rf.ret$TBILLS.Close),
               100*maxDrawdown(Returns,invert = FALSE),
               100*c(Return.annualized(Return.calculate(Cl(SACPI))[SubsetPeriod.Reporting],scale = 12)),
               # Sortino
               SortinoRatio(Returns, MAR = 0),
               #Ulcer Index
               100*UlcerIndex(Returns),
               #Calmar Ratio
               CalmarRatio(Returns["2014::2017"], scale = 12)
               )

colnames(stats) <- c("Timing",
                     "Delayed Timing")

rownames(stats) <- c("Return",
                     "Volatility",
                     "Sharpe", #what %?
                     "MaxDD",
                     "Inflation CAGR",
                     "Sortino Ratio",
                     
                     "Ulcer Index",
                     "Calmar Ratio")

round(stats,2)
#show time in mkt?
c("10m Timing","10m Timing Delayed")
chart.RollingPerformance(Returns$"10m Timing Delayed"-Returns$"10m Timing", 
                         width = 3,
                         main = "Rolling Perf"
                         )



```

```{r}
chart_Series(Cl(SA10YR),
  name = paste("SA10YR vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = "1983::1986-06",
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )
```


####Including Property

```{r, message=FALSE, warning=FALSE}
#remove past data
rm(list = ls(envir = globalenv()),envir = globalenv()) #clear Vars from global enviroment

#Set Symbols
symbols <- c("TBILLS","JALSH","MSCIWORLD","SA10YR","GSCI","JASPY","SACPI")

#Import saved pricing data csv files as xts
getSymbols(symbols,
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#Define subset dates for different period
SubsetPeriod.Reporting <- "1993-12-31::2016-12-31"
SubsetPeriod.Calculations <- "1992-12-31::2016-12-31"

AllAssets <- cbind.xts(Cl(TBILLS),
                       Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       Cl(JASPY),
                       Cl(SACPI))                       

AllAssets <- AllAssets[SubsetPeriod.Reporting]
colnames(AllAssets) <- symbols

#calculate returns and cum returns
AllAssets.ret <- Return.calculate(AllAssets)[-1,]
AllAssets.cumret <- 100*cumprod(1+ ROC(AllAssets, type = "discrete")[-1,])
#how do i add a row at the top with value of 100 for each? rbind?

chart.TimeSeries(AllAssets.cumret[SubsetPeriod.Reporting],
 main = paste("Figure X - SA Asset Class Returns, Log Scale",sep = ""),
 ylab = "",
 #ylog = TRUE,
 #ylim = c(100,250000),
 #date.format = "%Y",
 major.ticks = "years",
 legend.loc = "topleft",
 colorset = c("orangered3","olivedrab","slateblue","blue","gold2","dodgerblue2","cornflowerblue")
 #minor.ticks =FALSE
 )

#how do i change scale format!
```

```{r}
#Create xts for Returns
Returns <- AllAssets.ret[SubsetPeriod.Reporting]

#calculate statistics and store as "stats"
stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS),
               100*maxDrawdown(Returns,scale = 12,invert = FALSE),
               100*c(Return.annualized(Returns$SACPI,scale = 12)))

#rename table rows/column names and format
colnames(stats) <- symbols
rownames(stats) <- c("Return",
                     "Volatility",
                     paste("Sharpe (",round(stats[1,"TBILLS"],2),"%)", sep = ""),
                     "MaxDD",
                     "Inflation CAGR")

stats <- round(stats[,-7],2) #delete inflation column - change to 7 when including property.

#print
stats

#copies stats to clipboad for pasting into word/excel
#write.table(stats, "clipboard", sep="\t", col.names=NA) 
```


```{r}
myChart_Theme <- chart_theme() #Create a chart_theme
myChart_Theme$col$line.col <- "blue"

SMAperiod <- 10

chart_Series(Cl(JALSH),
  name = paste("JALSH vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(MSCIWORLD),
  name = paste("MSCI World vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(SA10YR),
  name = paste("SA10YR vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(GSCI),
  name = paste("GSCI vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )

chart_Series(Cl(JASPY),
  name = paste("JASPY vs 10 Month Simple Moving Average",sep = ""),
  theme=myChart_Theme,
  type = "line",
  subset = SubsetPeriod.Reporting,
  TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
  )
```


####Calculating returns

```{r, message=FALSE, warning=FALSE}
#Import saved pricing data csv files as xts
getSymbols("TBILLYIELDS",
           src = "csv",
           dir="../Data/CSV files/SA Long Term/",
           col.names=c("Close"))

#load an additional library
library(dplyr)

#Create new all assets
AllAssets <- cbind.xts(Cl(JALSH),
                       Cl(MSCIWORLD),
                       Cl(SA10YR),
                       Cl(GSCI),
                       Cl(JASPY),
                       Cl(TBILLYIELDS))   

AllAssets <- AllAssets[SubsetPeriod.Calculations]

#create dataframe - tidyverse not compatible with xts?
AllAssets.df <- data.frame(date=index(AllAssets), coredata(AllAssets)) #, row.names = index(AllAssets))

bandwidth <- 0.02
#mutate new columns
AllAssets.df  <- mutate(AllAssets.df,
  "RF.ret" =  c(0,lag((TBILLYIELDS.Close/100)/12)[-1]), 
  #is this right?

  "JALSH.ret" =  c(0,diff(JALSH.Close)/lag(JALSH.Close)[-1]),
  
  "JALSH.2m.SMA" =  rollmean(JALSH.Close,2,fill = 0,align = "right"),
  "JALSH.5m.SMA" =  rollmean(JALSH.Close,5,fill = 0,align = "right"),
  "JALSH.10m.SMA" =  rollmean(JALSH.Close,10,fill = 0,align = "right"),
  
  "JALSH.2m.signal" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,1,0)),
  "JALSH.5m.signal" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,1,0)),
  "JALSH.10m.signal" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,1,0)),
  "JALSH.2m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.2m.SMA,ifelse(JALSH.2m.signal==1,1,0),0)),
  "JALSH.5m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.5m.SMA,ifelse(JALSH.5m.signal==1,1,0),0)),  
  "JALSH.10m.signal.delayed" =  lag(ifelse(JALSH.Close>=JALSH.10m.SMA,ifelse(JALSH.10m.signal==1,1,0),0)),
  
  "JALSH.2m.timingret" = ifelse(JALSH.2m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret" = ifelse(JALSH.5m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret" = ifelse(JALSH.10m.signal == 1,JALSH.ret,RF.ret),
  "JALSH.2m.timingret.delayed" = ifelse(JALSH.2m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.5m.timingret.delayed" = ifelse(JALSH.5m.signal.delayed == 1,JALSH.ret,RF.ret),
  "JALSH.10m.timingret.delayed" = ifelse(JALSH.10m.signal.delayed == 1,JALSH.ret,RF.ret),
 
  "JALSH.avg.timingret" = (JALSH.2m.timingret + JALSH.5m.timingret + JALSH.10m.timingret)/3,
  "JALSH.avg.timingret.delayed" = (JALSH.2m.timingret.delayed + JALSH.5m.timingret.delayed + JALSH.10m.timingret.delayed)/3,  
  "JALSH.avg.combo" = (JALSH.avg.timingret + JALSH.avg.timingret.delayed)/2,

  "MSCIWORLD.ret" =  c(0,diff(MSCIWORLD.Close)/lag(MSCIWORLD.Close)[-1]),
  
  "MSCIWORLD.2m.SMA" =  rollmean(MSCIWORLD.Close,2,fill = 0,align = "right"),
  "MSCIWORLD.5m.SMA" =  rollmean(MSCIWORLD.Close,5,fill = 0,align = "right"),
  "MSCIWORLD.10m.SMA" =  rollmean(MSCIWORLD.Close,10,fill = 0,align = "right"),
  
  "MSCIWORLD.2m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,1,0)),
  "MSCIWORLD.5m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,1,0)),
  "MSCIWORLD.10m.signal" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,1,0)),
  "MSCIWORLD.2m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.2m.SMA,ifelse(MSCIWORLD.2m.signal==1,1,0),0)),
  "MSCIWORLD.5m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.5m.SMA,ifelse(MSCIWORLD.5m.signal==1,1,0),0)),  
  "MSCIWORLD.10m.signal.delayed" =  lag(ifelse(MSCIWORLD.Close>=MSCIWORLD.10m.SMA,ifelse(MSCIWORLD.10m.signal==1,1,0),0)),
  
  "MSCIWORLD.2m.timingret" = ifelse(MSCIWORLD.2m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret" = ifelse(MSCIWORLD.5m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret" = ifelse(MSCIWORLD.10m.signal == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.2m.timingret.delayed" = ifelse(MSCIWORLD.2m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.5m.timingret.delayed" = ifelse(MSCIWORLD.5m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  "MSCIWORLD.10m.timingret.delayed" = ifelse(MSCIWORLD.10m.signal.delayed == 1,MSCIWORLD.ret,RF.ret),
  
  "MSCIWORLD.avg.timingret" = (MSCIWORLD.2m.timingret + MSCIWORLD.5m.timingret + MSCIWORLD.10m.timingret)/3,
  "MSCIWORLD.avg.timingret.delayed" = (MSCIWORLD.2m.timingret.delayed + MSCIWORLD.5m.timingret.delayed + MSCIWORLD.10m.timingret.delayed)/3,
  "MSCIWORLD.avg.combo" = (MSCIWORLD.avg.timingret + MSCIWORLD.avg.timingret.delayed)/2,
    
  "SA10YR.ret" =  c(0,diff(SA10YR.Close)/lag(SA10YR.Close)[-1]),
  
  "SA10YR.2m.SMA" =  rollmean(SA10YR.Close,2,fill = 0,align = "right"),
  "SA10YR.5m.SMA" =  rollmean(SA10YR.Close,5,fill = 0,align = "right"),
  "SA10YR.10m.SMA" =  rollmean(SA10YR.Close,10,fill = 0,align = "right"),
  
  "SA10YR.2m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,1,0)),
  "SA10YR.5m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,1,0)),
  "SA10YR.10m.signal" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,1,0)),
  "SA10YR.2m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.2m.SMA,ifelse(SA10YR.2m.signal==1,1,0),0)),
  "SA10YR.5m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.5m.SMA,ifelse(SA10YR.5m.signal==1,1,0),0)),  
  "SA10YR.10m.signal.delayed" =  lag(ifelse(SA10YR.Close>=SA10YR.10m.SMA,ifelse(SA10YR.10m.signal==1,1,0),0)),
  
  "SA10YR.2m.timingret" = ifelse(SA10YR.2m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret" = ifelse(SA10YR.5m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret" = ifelse(SA10YR.10m.signal == 1,SA10YR.ret,RF.ret),
  "SA10YR.2m.timingret.delayed" = ifelse(SA10YR.2m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.5m.timingret.delayed" = ifelse(SA10YR.5m.signal.delayed == 1,SA10YR.ret,RF.ret),
  "SA10YR.10m.timingret.delayed" = ifelse(SA10YR.10m.signal.delayed == 1,SA10YR.ret,RF.ret),
  
  "SA10YR.avg.timingret" = (SA10YR.2m.timingret + SA10YR.5m.timingret + SA10YR.10m.timingret)/3,
  "SA10YR.avg.timingret.delayed" = (SA10YR.2m.timingret.delayed + SA10YR.5m.timingret.delayed + SA10YR.10m.timingret.delayed)/3,
  "SA10YR.avg.combo" = (SA10YR.avg.timingret + SA10YR.avg.timingret.delayed)/2,
  
  "GSCI.ret" =  c(0,diff(GSCI.Close)/lag(GSCI.Close)[-1]),
  
  "GSCI.2m.SMA" =  rollmean(GSCI.Close,2,fill = 0,align = "right"),
  "GSCI.5m.SMA" =  rollmean(GSCI.Close,5,fill = 0,align = "right"),
  "GSCI.10m.SMA" =  rollmean(GSCI.Close,10,fill = 0,align = "right"),
  
  "GSCI.2m.signal" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,1,0)),
  "GSCI.5m.signal" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,1,0)),
  "GSCI.10m.signal" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,1,0)),
  "GSCI.2m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.2m.SMA,ifelse(GSCI.2m.signal==1,1,0),0)),
  "GSCI.5m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.5m.SMA,ifelse(GSCI.5m.signal==1,1,0),0)),  
  "GSCI.10m.signal.delayed" =  lag(ifelse(GSCI.Close>=GSCI.10m.SMA,ifelse(GSCI.10m.signal==1,1,0),0)),
   
  "GSCI.2m.timingret" = ifelse(GSCI.2m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret" = ifelse(GSCI.5m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret" = ifelse(GSCI.10m.signal == 1,GSCI.ret,RF.ret),
  "GSCI.2m.timingret.delayed" = ifelse(GSCI.2m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.5m.timingret.delayed" = ifelse(GSCI.5m.signal.delayed == 1,GSCI.ret,RF.ret),
  "GSCI.10m.timingret.delayed" = ifelse(GSCI.10m.signal.delayed == 1,GSCI.ret,RF.ret),

  "GSCI.avg.timingret" = (GSCI.2m.timingret + GSCI.5m.timingret + GSCI.10m.timingret)/3,
  "GSCI.avg.timingret.delayed" = (GSCI.2m.timingret.delayed + GSCI.5m.timingret.delayed + GSCI.10m.timingret.delayed)/3,
  "GSCI.avg.combo" = (GSCI.avg.timingret + GSCI.avg.timingret.delayed)/2,

  "JASPY.ret" =  c(0,diff(JASPY.Close)/lag(JASPY.Close)[-1]),
  
  "JASPY.2m.SMA" =  rollmean(JASPY.Close,2,fill = 0,align = "right"),
  "JASPY.5m.SMA" =  rollmean(JASPY.Close,5,fill = 0,align = "right"),
  "JASPY.10m.SMA" =  rollmean(JASPY.Close,10,fill = 0,align = "right"),
  
  "JASPY.2m.signal" =  lag(ifelse(JASPY.Close>=JASPY.2m.SMA,1,0)),
  "JASPY.5m.signal" =  lag(ifelse(JASPY.Close>=JASPY.5m.SMA,1,0)),
  "JASPY.10m.signal" =  lag(ifelse(JASPY.Close>=JASPY.10m.SMA,1,0)),
  "JASPY.2m.signal.delayed" =  lag(ifelse(JASPY.Close>=JASPY.2m.SMA,ifelse(JASPY.2m.signal==1,1,0),0)),
  "JASPY.5m.signal.delayed" =  lag(ifelse(JASPY.Close>=JASPY.5m.SMA,ifelse(JASPY.5m.signal==1,1,0),0)),  
  "JASPY.10m.signal.delayed" =  lag(ifelse(JASPY.Close>=JASPY.10m.SMA,ifelse(JASPY.10m.signal==1,1,0),0)),
   
  "JASPY.2m.timingret" = ifelse(JASPY.2m.signal == 1,JASPY.ret,RF.ret),
  "JASPY.5m.timingret" = ifelse(JASPY.5m.signal == 1,JASPY.ret,RF.ret),
  "JASPY.10m.timingret" = ifelse(JASPY.10m.signal == 1,JASPY.ret,RF.ret),
  "JASPY.2m.timingret.delayed" = ifelse(JASPY.2m.signal.delayed == 1,JASPY.ret,RF.ret),
  "JASPY.5m.timingret.delayed" = ifelse(JASPY.5m.signal.delayed == 1,JASPY.ret,RF.ret),
  "JASPY.10m.timingret.delayed" = ifelse(JASPY.10m.signal.delayed == 1,JASPY.ret,RF.ret),

  "JASPY.avg.timingret" = (JASPY.2m.timingret + JASPY.5m.timingret + JASPY.10m.timingret)/3,
  "JASPY.avg.timingret.delayed" = (JASPY.2m.timingret.delayed + JASPY.5m.timingret.delayed + JASPY.10m.timingret.delayed)/3,
  "JASPY.avg.combo" = (JASPY.avg.timingret + JASPY.avg.timingret.delayed)/2,

  "BuyandHold.ret" = (JALSH.ret + MSCIWORLD.ret + SA10YR.ret + GSCI.ret + JASPY.ret)/5,
  "Timing.ret" = (JALSH.10m.timingret + MSCIWORLD.10m.timingret + SA10YR.10m.timingret + GSCI.10m.timingret + JASPY.10m.timingret)/5,
  "DelayedTiming.ret" = (JALSH.10m.timingret.delayed + MSCIWORLD.10m.timingret.delayed + SA10YR.10m.timingret.delayed + GSCI.10m.timingret.delayed 
                         + JASPY.10m.timingret.delayed)/5,
  "Avg.Timing.ret" = (JALSH.avg.timingret + MSCIWORLD.avg.timingret + SA10YR.avg.timingret + GSCI.avg.timingret + JASPY.avg.timingret)/5,
  "Avg.DelayedTiming.ret" = (JALSH.avg.timingret.delayed + MSCIWORLD.avg.timingret.delayed + 
                            SA10YR.avg.timingret.delayed + JASPY.avg.timingret.delayed + GSCI.avg.timingret.delayed)/5,
  "Avg.Combo.ret" = (JALSH.avg.combo + MSCIWORLD.avg.combo + 
                            SA10YR.avg.combo + GSCI.avg.combo + JASPY.avg.combo)/5
  
  )

rownames(AllAssets.df) <- index(AllAssets)

#Create xts of calculations to analyse performance
AllAssets.xts <- xts(AllAssets.df[,-1], order.by = AllAssets.df$date)

#detach the packagae dplyr as it isn't compatible with other packages?
detach(package:dplyr)
```

#### Property Timng Strategy Comparisons

```{r}
#for calculating the sharpe ratio later
Rf.ret <- Return.calculate(TBILLYIELDS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

#MSCI World
Returns <- cbind.xts(AllAssets.xts$JASPY.ret, 
                     AllAssets.xts$JASPY.10m.timingret, 
                     AllAssets.xts$JASPY.10m.timingret.delayed, 
                     AllAssets.xts$JASPY.avg.timingret,
                     AllAssets.xts$JASPY.avg.timingret.delayed,
                     AllAssets.xts$JASPY.avg.combo)[SubsetPeriod.Reporting]

CumReturns <- 100*cumprod(1+Returns[-1,])
colnames(CumReturns) <- c("Buy and Hold","Timing","Timing Delayed","Avg Timing","Avg Timing Delayed","Avg Combo")
colnames(Returns) <- c("Buy and Hold","Timing","Timing Delayed","Avg Timing","Avg Timing Delayed","Avg Combo")

#how do i add earlier row and make it 100

#as.numeric(substr(SubsetPeriod,1,4))+1
chart.TimeSeries(CumReturns,
  main = paste("Buy and Hold vs Timing vs Timing Avg, ",
               substr(SubsetPeriod.Reporting,1,4),"-",
               substr(SubsetPeriod.Reporting,13,16),
               ", Log Scale",sep = ""),
  date.format = "%Y",
  colorset = c(4,2,3,5,6,7),
  ylab = "",
  ylog = TRUE,
  #ylim = c(50,1000),
  legend.loc = "topleft",
  major.ticks = "years",
  minor.ticks = FALSE)

chart.Drawdown(Returns,#[,-1], to exclude B&H
  main = paste("Buy and Hold vs Timing vs Timing Avg",substr(SubsetPeriod.Reporting,1,4),"-",substr(SubsetPeriod.Reporting,13,16),", Non-log Scale",sep = ""),
  date.format = "%Y",
  colorset = c(4,2,3,5,6),
  ylab = "Drawdown",
  legend.loc = "bottomright",
  major.ticks = "years",
  minor.ticks = FALSE)

```

```{r}
stats <- rbind(Return.annualized(Returns,scale = 12)*100, 
               StdDev.annualized(Returns,scale = 12)*100, 
               SharpeRatio.annualized(Returns,Rf = Rf.ret$TBILLYIELDS.Close),
               maxDrawdown(Returns,scale = 12,invert = FALSE)*100,
               
               # Sortino
               SortinoRatio(Returns, MAR = 0),
               
               #Information Ratio
               InformationRatio(Returns, Returns$"Buy and Hold"),
               
               #Ulcer Index
               100*UlcerIndex(Returns),
               
               #Calmar Ratio
               CalmarRatio(Returns["2014::2017"], scale = 12)
               
               )
               
colnames(stats) <- c("Buy and Hold","Timing","Timing Delayed","Average Timing","Average Timing Delayed","Avg Combo")
rownames(stats) <- c("Return",
                     "Volatility",
                     "Sharpe",
                     "MaxDD",
                     # "% Positive Months",
                     # "% Months invested in the Asset",
                     # "% Positive Months when invested",
                     "Sortino Ratio",
                     "Information Ratio",
                     "Ulcer Index",
                     "Calmar Ratio")

round(stats,2)
write.table(round(stats,4), "clipboard", sep="\t", col.names=NA)
```
####GTAA Performance Charts

```{r}
Returns <- cbind.xts(AllAssets.xts$BuyandHold.ret,
                     AllAssets.xts$Timing.ret,
                     AllAssets.xts$DelayedTiming.ret,
                     AllAssets.xts$Avg.Timing.ret,
                     AllAssets.xts$Avg.DelayedTiming.ret,
                     AllAssets.xts$Avg.Combo.ret)[SubsetPeriod.Reporting]

CumReturns <- 100*cumprod(1+Returns[-1,])
colnames(CumReturns) <- c("Buy & Hold","Timing","Delayed Timing","Avg Timing","Avg Delayed Timing","Avg Combo")

chart.TimeSeries(CumReturns,
  main = "Figure X - Timing Model Comparison, Log Scale",
  date.format = "%Y",
  colorset = c(4,2,3,5,6,7),
  ylab = "",
  ylog = TRUE,
  #ylim = c(100,76000),
  legend.loc = "topleft",
  major.ticks = "years",
  minor.ticks = FALSE,
  yaxis = TRUE)

chart.TimeSeries(CumReturns,
  main = "Figure X - Timing Model Comparison, Non Log Scale",
  date.format = "%Y",
  colorset = c(4,2,3,5,6,7),
  ylab = "",
  ylog = FALSE,
  #ylim = c(100,500),
  legend.loc = "topleft",
  major.ticks = "years",
  minor.ticks = FALSE)
```

```{r}
Rf.ret <- Return.calculate(TBILLS)[-1,]
Rf.ret <- Rf.ret[SubsetPeriod.Reporting]

Returns <- cbind.xts(AllAssets.xts$BuyandHold.ret,
                     AllAssets.xts$Timing.ret,
                     AllAssets.xts$DelayedTiming.ret,
                     AllAssets.xts$Avg.Timing.ret,
                     AllAssets.xts$Avg.DelayedTiming.ret,
                     AllAssets.xts$Avg.Combo.ret)[SubsetPeriod.Reporting]

stats <- rbind(100*Return.annualized(Returns,scale = 12), 
               100*StdDev.annualized(Returns,scale = 12), 
               SharpeRatio.annualized(Returns,Rf = Rf.ret$TBILLS.Close),
               100*maxDrawdown(Returns,invert = FALSE),
               100*c(Return.annualized(Return.calculate(Cl(SACPI))[SubsetPeriod.Reporting],scale = 12)),
               
               # Sortino
               SortinoRatio(Returns, MAR = 0),
               
               #Information Ratio
               InformationRatio(Returns, Returns$BuyandHold.ret),
               
               #Ulcer Index
               100*UlcerIndex(Returns),
               
               #Calmar Ratio
               CalmarRatio(Returns["2014::2017"], scale = 12)
               )

colnames(stats) <- c("Buy & Hold",
                     "Timing",
                     "Delayed Timing",
                     "Avg Timing",
                     "Avg Delayed Timing",
                     "Avg Combo")

rownames(stats) <- c("Return",
                     "Volatility",
                     "Sharpe", #what %?
                     "MaxDD",
                     "Inflation CAGR",
                     "Sortino Ratio",
                     "Information Ratio",
                     "Ulcer Index",
                     "Calmar Ratio")

round(stats,2)
#write.table(round(stats,4), "clipboard", sep="\t", col.names=NA)
```


so better sharpe? [confirm calc method/fix interest rate... should i calc manually?] and less maxdd
whats kurtosis, information ratio, skew. ask what metrics rad, mb and emyln use...
run on longer dater in asset allocation ratios

last 12 months, 3 years, etc returns

rolling returns

to do:

* how to calculate dailyreturns with NA
* check returns make sense - effect of zar?
* compare to US / JPY
* create RF to get 2002 in

To do:
SA assets
Daily drawdowns
monthly returns table
Relative performance / rolling perofrmance / alpha
10 worst periods / 10 best periods 
do different averages improve SA - check robustness of averages....