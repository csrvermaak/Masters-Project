---
title: "Reproduction of Faber 2012"
output: html_notebook
---

###Introduction

Mebane Faber released a paper in 2006 (http://papers.ssrn.com/sol3/papers.cfm?abstract_id=962461) which applies a trend following market timing model to manage risk on a portfolio equally weighted with 5 asset classes (20% US Large Cap Equities, 20% Foreign Developed Equities, 20% US 10yr Gov Bonds, 20% commodities and 20% real estate).
 
The results showed the simple moving average based market timing system commonly used in CTAs could be applied to asset allocation to significant improve the performance and risk metrics compared to a standard buy and hold strategy. Depending on the moving average period used, the market timing system had similar or slightly better returns (9.54-10.73% CAGR vs 9.92% CAGR) to the buy and hold strategy. However, the timing system reduced volatility from 10.28% to 6.83%-7.09%, improving the sharpe ratio (rf 5.41%) from 0.44 to 0.60-0.77. Max DD was also significantly improved from 46% to 9.76%-17.42%.

###Replicating the original research

####Data used

Faber's model is applied to 5 asset classes - US Equities, Foreign Develeped country equities, Fixed Income, Commodities and Real Assets/Real estate. He uses the following data series to represent these asset classes. 

- S&P 500
- MSCI EAFE
- US 10 Year Government Bonds
- Goldman Sachs Commodity Index
- NAREIT Index

All data series are total return series including dividends and income. Monthly data is used over the period 1972-2012 which i have extended to include up to the end of 2016 for further analysis.

The data provider for Fabers research is Global Financial Data -  unfortunately a paid service i could get access to.

4 of the 5 indices were available on Bloomberg. The US 10 Yr Government bonds total returns index had to be recreated using yields available on FRED. Although there are small discrepancies in performance statistics i am confident the data is close enough to the original data that it can be used.See appendix for more details.

####Importing the data into R

Each asset's class price series has been saved as a CSV. The packages used for performance analysis and backtesting require the data to be xts objects which are created by the following code.

```{r, message=FALSE}
#Import saved pricing data csv files as xts
rm(list = ls())

library(PerformanceAnalytics)
#library(tidyverse) can't use tidyverse - it changes R base code and breaks return.calculate
#library(tidyquant)
library(quantstrat)
symbols <- c("TBILLS","SP500","EAFE","US10YR","GSCI","NAREIT","CPI")

getSymbols(symbols,
           src = "csv",
           dir="../Data/CSV files",
           col.names=c("Close"))

```

#### Manipulating the data

Once the data is loaded i can create one xts object for the prices and calculate each asset class's returns. The asset class returns are then charted to replicate figure 3 on page 16.

```{r}
AllAssets <- cbind.xts(Cl(TBILLS),
                       Cl(SP500),
                       Cl(EAFE),
                       Cl(US10YR),
                       Cl(GSCI),
                       Cl(NAREIT),
                       Cl(CPI))                       

AllAssets <- AllAssets["1972-12-31::2016-12-31"]
colnames(AllAssets) <- symbols

AllAssets.ret <- Return.calculate(AllAssets)[-1,]
AllAssets.cumret <- 100*cumprod(1+ ROC(AllAssets, type = "discrete")[-1,])

chart.TimeSeries(AllAssets.cumret["1972-12-31::2012-12-31"],
                 main = "Figure 3 - Asset Class Returns 1973-2012, Log Scale",
                 #lty = "2",
                 ylab = "",
                 ylog = TRUE,
                 ylim = c(40,6000),
                 date.format = "%Y",
                 major.ticks = "years",
                 legend.loc = "bottomright",
                 colorset = c("orangered3","olivedrab","slateblue","blue","gold2","dodgerblue2","cornflowerblue"), #bluefocus, #create own colorset at some point
                 minor.ticks =FALSE)
```

To do:

* add CPI
* create same colourset / scale


####Analysing returns and drawdowns.


```{r}
#subset to required dates
Returns <- AllAssets.ret["1972-12-31::2012-12-31"]
stats <- rbind(Return.annualized(Returns,scale = 12)*100, 
               StdDev.annualized(Returns,scale = 12)*100, 
               SharpeRatio.annualized(Returns,Rf = AllAssets.ret$TBILLS),
               maxDrawdown(Returns,scale = 12,invert = FALSE)*100,
               c(100*Return.annualized(Returns$CPI,scale = 12)))

colnames(stats) <- symbols
rownames(stats) <- c("Return","Volatility","Sharpe (5.41%)","MaxDD","Inflation CAGR")
round(stats[,-7],2)
```

To do:

* confirm correct rate for Rf (Faber uses 5.41%) and that sharpe ratio is calculating correctly. TBILL should be zero!
* note that sharpe 5.41% is actually 4.8% according to the R model. Diff between monthly and annual?
* format into percentages
* is table needed showing differences to original research?
* source actual inflation


####Drawdown chart

To give the reader a visual perspective of drawdowns, faber shows the drawdowns for the S&P from 1900-2012

```{r}
chart.Drawdown(AllAssets.ret$`SP500`["1972-12-31::2012-12-31"],
               main = "Figure 5 - S&P Drawdowns 1972-2012",
               ylab = "",
               date.format = "%Y",
               major.ticks = "years",
               colorset = redfocus)

```

To do:

* get data for the S&P500 TR from 1900
* Do for all assets in loop?
* fill in colour

####Managing Risk 

Faber introduces a timing system for investors to use to manage the risk.... using a 10 month simple moving average timing model

```{r}
myChart_Theme <- chart_theme() #Create a chart_theme
myChart_Theme$col$line.col <- "blue"

SMAperiod <- 10

chart_Series(Cl(SP500),
             name = "Figure 6 - S&P vs 10 Month Simple Moving Average",
             theme=myChart_Theme,
             type = "line",
             subset = "1989-12-31::2012-12-31",
             TA = 'add_SMA(n=SMAperiod, on=1, col="red")'
             )
```

To - do 

* look at adding visualisation when its in / out of the market http://timelyportfolio.blogspot.co.za/2011/08/drawdown-visualization.html

#### System Rules

* Buy when monthly price > 10m SMA
* Sell and move to cash when monthly price < 10m SMA

Notes:

* All entry and exit prices are on day of the signal at the close
** means intray price fluctuations are ignored
** also should look at trading the next day/week or month?
* no taxes commissions or slippages

####S&P 500 from 1901 - 2012

To demostrate the logic and characteristics of the timing system, Faber tests the S&P back to 1901. As i can't get data i will use the INDU (dow jones) as a substitute for now. Note not total returns. Now using shillers data...

```{r, warning=FALSE}
library(dplyr)
getSymbols(c("SP500","TBillYields"),
           src = "csv",
           dir="../Data/CSV files",
           col.names=c("Close"))

AllAssets <- cbind.xts(Cl(SP500),
                       Cl(TBILLYIELDS))    

#create dataframe - tidyverse not compatible with xts?
AllAssets.df <- data.frame(date=index(AllAssets), coredata(AllAssets)) #, row.names = index(AllAssets))

#mutate new columns
AllAssets.df  <- mutate(AllAssets.df, 
  "10mSMA" = rollmean(SP500.Close,10,fill = 0,align = "right"),
  "Asset.ret" = c(0,diff(SP500.Close)/lag(SP500.Close)[-1]),
  "Rf.ret" = lag((TBILLYIELDS.Close/100)/12),
  "signal" = lag(ifelse(SP500.Close>`10mSMA`,1,0)),
  "Timing.ret" = ifelse(signal == 1,Asset.ret,Rf.ret) 
)

rownames(AllAssets.df) <- index(AllAssets)
```

To do:

* check lag correct
* run over data from 1900 / other assets
* chart with periods highlighted (similar to position chart)
* work out how to have dplyr work with other packages
need rf from 1900 as well

####Stats

```{r}
AllAssets <- as.xts(AllAssets.df[,-1])
Returns <- cbind.xts(AllAssets$Asset.ret, AllAssets$Timing.ret)["1972-12-31::2012-12-31"]

stats <- rbind(Return.annualized(Returns,scale = 12)*100, 
               StdDev.annualized(Returns,scale = 12)*100, 
               SharpeRatio.annualized(Returns,Rf = 0.0541/12),
               maxDrawdown(Returns,scale = 12,invert = FALSE)*100,
               c(nrow(subset(Returns, Returns$Asset.ret >= 0))/nrow(Returns),nrow(subset(Returns, Returns$Timing.ret >= 0))/nrow(Returns))*100)

colnames(stats) <- c("SP500","TIMING")
rownames(stats) <- c("Return","Volatility","Sharpe","MaxDD","% Positive Months")

round(stats,2)
```

To do:

* do with data from 1900
* feed in correct Rf for period
* format percentages
* add $100 becomes and inflation CAGR
* loop for other asset classes
* add for another asset class
* confirm Rf / charpe sharpe to feed off Rf

####Charts 

```{r}
charts.PerformanceSummary(Returns,
                          main = "SP500 Total Returns vs Timing Total Returns (1973-2012)",
                          date.format = "%Y",
                          colorset = c(4,2),
                          ylog = TRUE,
                          minor.ticks =FALSE)

```

to do: add in position chart.


```{r}
charts.RollingPerformance(Returns,
                          main = "SP500 Total Returns vs Timing Total Returns (1973-2012)",
                          date.format = "%Y",
                          colorset = c(4,2),
                          ylog = FALSE,
                          minor.ticks =FALSE)
```

To do: 

* calculate returns for year before so rolling returns correct from day 1
* Look at bad data in 1975-1984
* change scale to 6 months?
